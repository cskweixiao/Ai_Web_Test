# ğŸ“Š ç¼“å­˜ç»Ÿè®¡æ•°æ®æ¥æºè¯´æ˜

## ğŸ¯ æ•°æ®æµç¨‹å›¾

```
æµ‹è¯•æ‰§è¡Œ 
    â†“
å…ƒç´ è¯†åˆ«è¯·æ±‚
    â†“
mcpClient.findBestElement() 
    â†“
æ£€æŸ¥ç¼“å­˜ (elementCache.get())
    â”œâ”€ å‘½ä¸­ âœ… â†’ è¿”å›ç¼“å­˜æ•°æ® (cacheHits++)
    â””â”€ æœªå‘½ä¸­ âŒ â†’ è°ƒç”¨AIè¯†åˆ« (cacheMisses++)
           â†“
       å­˜å…¥ç¼“å­˜ (elementCache.set())
           â†“
    æ›´æ–°ç»Ÿè®¡æ•°æ®
```

## ğŸ“ æ•°æ®æ¥æºä½ç½®

### 1. å…ƒç´ ç¼“å­˜æ•°æ®

**æ–‡ä»¶**: `server/services/elementCache.ts`

```typescript
export class ElementCache {
  private cache: Map<string, CachedElement> = new Map();
  private stats = {
    totalRequests: 0,    // æ¯æ¬¡get()è°ƒç”¨æ—¶+1
    cacheHits: 0,        // ç¼“å­˜å‘½ä¸­æ—¶+1
    cacheMisses: 0       // ç¼“å­˜æœªå‘½ä¸­æ—¶+1
  };
}
```

**è§¦å‘æ—¶æœº**:
- âœ… **æµ‹è¯•æ‰§è¡Œæ—¶**: æ¯æ¬¡è¯†åˆ«å…ƒç´ éƒ½ä¼šè°ƒç”¨
- âœ… **MCPå‘½ä»¤æ‰§è¡Œ**: `mcpClient.findBestElement()`
- âœ… **AIè§£ææ­¥éª¤**: `aiParser.generateMCPCommand()`

### 2. æ•°æ®æ›´æ–°æµç¨‹

#### æ­¥éª¤1: æµ‹è¯•æ‰§è¡Œ
```typescript
// testExecution.ts
await this.executeTestInternal(runId, testCaseId);
  â†“
await this.executeMcpCommand(step, runId);
  â†“
// mcpClient.ts
await this.findBestElement(selector, runId);
```

#### æ­¥éª¤2: ç¼“å­˜æŸ¥è¯¢
```typescript
// mcpClient.ts -> findBestElement()
const cacheKey = elementCache.generateCacheKey(url, selector, fingerprint);
const cachedElement = elementCache.get(cacheKey);  // â† è¿™é‡Œæ›´æ–°ç»Ÿè®¡
```

#### æ­¥éª¤3: ç¼“å­˜å­˜å‚¨
```typescript
// å¦‚æœæœªå‘½ä¸­ï¼ŒAIè¯†åˆ«åå­˜å‚¨
elementCache.set(cacheKey, {
  ref: matchedElement.ref,
  text: matchedElement.text,
  confidence: matchedElement.confidence
});
```

## ğŸ” å¦‚ä½•éªŒè¯æ•°æ®æ­£å¸¸

### æ–¹æ³•1: æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹

1. **è¿è¡Œä»»æ„æµ‹è¯•ç”¨ä¾‹**
2. **åˆ·æ–°ç¼“å­˜ç»Ÿè®¡é¡µé¢**
3. **è§‚å¯Ÿæ•°æ®å˜åŒ–**

```
ç¬¬ä¸€æ¬¡è¿è¡Œ:
- totalRequests: 5
- cacheHits: 0
- cacheMisses: 5
- hitRate: 0%

ç¬¬äºŒæ¬¡è¿è¡Œ(ç›¸åŒæµ‹è¯•):
- totalRequests: 10
- cacheHits: 5     â† å‘½ä¸­äº†ï¼
- cacheMisses: 5
- hitRate: 50%
```

### æ–¹æ³•2: æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

è¿è¡Œæµ‹è¯•æ—¶ï¼Œæ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š

```bash
# ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼ˆæœªå‘½ä¸­ï¼‰
ğŸ¤– [run-123] ===== AIå…ƒç´ è§£æå¼€å§‹ =====
ğŸ” [run-123] ç›®æ ‡æè¿°: "ç™»å½•æŒ‰é’®"
âœ… [run-123] AIåŒ¹é…æˆåŠŸï¼
ğŸ’¾ å…ƒç´ å·²ç¼“å­˜ (å½“å‰: 1/1000)

# ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆå‘½ä¸­ï¼‰
âš¡ [run-456] ä½¿ç”¨ç¼“å­˜å…ƒç´ ï¼Œè·³è¿‡AIè°ƒç”¨
âœ… ç¼“å­˜å‘½ä¸­: "ç™»å½•" (å‘½ä¸­2æ¬¡)
```

### æ–¹æ³•3: ç›´æ¥æŸ¥è¯¢API

```bash
# PowerShell
Invoke-RestMethod http://localhost:3001/api/config/cache/stats | ConvertTo-Json

# Curl
curl http://localhost:3001/api/config/cache/stats
```

## ğŸ› ä¸ºä»€ä¹ˆå‰ç«¯é¡µé¢æ²¡æœ‰æ•°æ®ï¼Ÿ

### å¸¸è§åŸå› 

#### 1ï¸âƒ£ **æœåŠ¡å™¨åœ°å€ä¸åŒ¹é…**

**é—®é¢˜**: Viteä»£ç†é…ç½®çš„åœ°å€ä¸å®é™…æœåŠ¡å™¨åœ°å€ä¸åŒ

**æ£€æŸ¥**:
```typescript
// vite.config.ts
const backendHost = env.SERVER_HOST || 'localhost';  // â† æ£€æŸ¥è¿™é‡Œ
const backendPort = env.PORT || '3001';
```

**è§£å†³**: 
- æœ¬åœ°å¼€å‘: ä½¿ç”¨ `localhost`
- è¿œç¨‹æœåŠ¡å™¨: è®¾ç½®ç¯å¢ƒå˜é‡ `SERVER_HOST=172.19.1.111`

#### 2ï¸âƒ£ **å‰ç«¯æœªé‡å¯**

**é—®é¢˜**: ä¿®æ”¹Viteé…ç½®åæœªé‡å¯å‰ç«¯æœåŠ¡

**è§£å†³**:
```bash
# åœæ­¢å‰ç«¯ (Ctrl+C)
# é‡æ–°å¯åŠ¨
npm run dev
```

#### 3ï¸âƒ£ **è¿˜æ²¡æœ‰æµ‹è¯•æ•°æ®**

**é—®é¢˜**: ç¼“å­˜ç³»ç»Ÿåˆšå¯ç”¨ï¼Œè¿˜æ²¡æœ‰è¿è¡Œè¿‡æµ‹è¯•

**è§£å†³**: 
1. è¿è¡Œä»»æ„æµ‹è¯•ç”¨ä¾‹
2. åˆ·æ–°ç¼“å­˜ç»Ÿè®¡é¡µé¢
3. æ•°æ®åº”è¯¥å‡ºç°äº†

#### 4ï¸âƒ£ **CORSé—®é¢˜**

**é—®é¢˜**: è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢

**æ£€æŸ¥**: æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Networkæ ‡ç­¾ â†’ æŸ¥çœ‹è¯·æ±‚çŠ¶æ€

**è§£å†³**: ç¡®ä¿å‰ç«¯é€šè¿‡Viteä»£ç†è®¿é—®APIï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ `/api/...`ï¼‰

## âœ… å®Œæ•´éªŒè¯æ­¥éª¤

### Step 1: æ£€æŸ¥åç«¯æœåŠ¡
```bash
# è®¿é—®APIç›´æ¥è·å–æ•°æ®
curl http://localhost:3001/api/config/cache/stats

# æˆ–åœ¨æµè§ˆå™¨æ‰“å¼€
http://localhost:3001/api/config/cache/stats
```

### Step 2: æ£€æŸ¥Viteé…ç½®
```bash
# æŸ¥çœ‹å½“å‰é…ç½®
cat vite.config.ts | grep backendHost

# åº”è¯¥æ˜¾ç¤º: const backendHost = env.SERVER_HOST || 'localhost';
```

### Step 3: é‡å¯å‰ç«¯
```bash
# åœæ­¢å½“å‰å‰ç«¯æœåŠ¡
Ctrl + C

# é‡æ–°å¯åŠ¨
npm run dev
```

### Step 4: è¿è¡Œæµ‹è¯•ç”Ÿæˆæ•°æ®
1. è®¿é—®æµ‹è¯•ç”¨ä¾‹é¡µé¢
2. è¿è¡Œä»»æ„æµ‹è¯•ç”¨ä¾‹
3. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼ˆåº”è¯¥çœ‹åˆ°ç¼“å­˜ç›¸å…³æ—¥å¿—ï¼‰

### Step 5: æŸ¥çœ‹ç»Ÿè®¡é¡µé¢
1. è®¿é—®ç¼“å­˜ç»Ÿè®¡é¡µé¢
2. ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®
3. åº”è¯¥èƒ½çœ‹åˆ°æ•°æ®äº†

## ğŸ“Š é¢„æœŸæ•°æ®ç¤ºä¾‹

### åˆå§‹çŠ¶æ€ï¼ˆæœªè¿è¡Œæµ‹è¯•ï¼‰
```json
{
  "totalRequests": 0,
  "cacheHits": 0,
  "cacheMisses": 0,
  "hitRate": 0,
  "totalElements": 0,
  "memoryUsage": 0,
  "status": "poor"
}
```

### è¿è¡Œ5ä¸ªæµ‹è¯•å
```json
{
  "totalRequests": 25,      // 5ä¸ªæµ‹è¯• Ã— å¹³å‡5ä¸ªå…ƒç´ 
  "cacheHits": 0,           // é¦–æ¬¡è¿è¡Œï¼Œå…¨éƒ¨æœªå‘½ä¸­
  "cacheMisses": 25,
  "hitRate": 0,
  "totalElements": 15,      // 15ä¸ªä¸åŒå…ƒç´ è¢«ç¼“å­˜
  "memoryUsage": 8,         // çº¦8KB
  "status": "poor"
}
```

### å†æ¬¡è¿è¡Œç›¸åŒæµ‹è¯•å
```json
{
  "totalRequests": 50,
  "cacheHits": 25,          // ç¬¬äºŒæ¬¡å…¨éƒ¨å‘½ä¸­ï¼
  "cacheMisses": 25,
  "hitRate": 50.0,          // å‘½ä¸­ç‡50%
  "totalElements": 15,
  "memoryUsage": 8,
  "status": "good"
}
```

## ğŸ”§ æ•…éšœæ’æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨ (`npm run dev`)
- [ ] åç«¯è¿è¡Œåœ¨3001ç«¯å£
- [ ] Viteé…ç½®ä¸­ `backendHost` æ­£ç¡®
- [ ] å‰ç«¯æœåŠ¡å·²é‡å¯
- [ ] è‡³å°‘è¿è¡Œè¿‡1ä¸ªæµ‹è¯•ç”¨ä¾‹
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [ ] Networkæ ‡ç­¾æ˜¾ç¤ºAPIè¯·æ±‚æˆåŠŸ

## ğŸ’¡ å¿«é€Ÿè°ƒè¯•å‘½ä»¤

```bash
# 1. æµ‹è¯•åç«¯API
curl http://localhost:3001/api/config/cache/stats

# 2. æŸ¥çœ‹Viteé…ç½®
grep backendHost vite.config.ts

# 3. æ£€æŸ¥å‰ç«¯æ˜¯å¦èƒ½è®¿é—®APIï¼ˆåœ¨å‰ç«¯è¿è¡Œæ—¶ï¼‰
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ:
fetch('/api/config/cache/stats').then(r => r.json()).then(console.log)

# 4. æŸ¥çœ‹ç¼“å­˜è¯¦ç»†æŠ¥å‘Š
curl http://localhost:3001/api/config/cache/report
```

## ğŸ¯ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| ç¼“å­˜ç»Ÿè®¡æ›´æ–° | `server/services/elementCache.ts` | 139-173 |
| å…ƒç´ ç¼“å­˜æŸ¥è¯¢ | `server/services/mcpClient.ts` | 764-830 |
| APIè·¯ç”±å®šä¹‰ | `server/routes/config.ts` | 356-406 |
| å‰ç«¯æ•°æ®è·å– | `src/pages/CacheStats.tsx` | 71-89 |
| Viteä»£ç†é…ç½® | `vite.config.ts` | 17-24 |

---

ğŸ“… æ›´æ–°æ—¶é—´: 2025-12-23  
ğŸ¯ ç›®çš„: å¸®åŠ©ç†è§£ç¼“å­˜æ•°æ®æµç¨‹å’Œæ’æŸ¥æ˜¾ç¤ºé—®é¢˜

