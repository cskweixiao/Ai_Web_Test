# 测试报告数据关联修复说明

## 修复内容

### 1. UI自动化测试 ↔ 报告系统关联

**修改文件**: `server/services/testCaseExecutionService.ts`

**新增功能**:
- 在 `syncFromTestRun()` 方法中，当测试完成时（status === 'completed' 或 'failed'），自动创建 `test_run_results` 记录
- 新增 `createTestRunResult()` 方法：创建 `test_run_results` 记录
- 新增 `findOrCreateTestRun()` 方法：查找或创建 `test_runs` 记录

**实现逻辑**:
1. 测试执行完成后，检查状态是否为 'completed' 或 'failed'
2. 查找或创建对应的 `test_runs` 记录
   - 如果有 `suiteId`，尝试查找已存在的 `test_runs` 记录
   - 如果没有，创建新的 `test_runs` 记录（使用默认测试套件）
3. 创建 `test_run_results` 记录
   - 映射状态：'completed' → 'PASSED'，'failed' → 'FAILED'
   - 保存执行时长、截图URL、执行时间等信息

### 2. 功能测试 ↔ 报告系统关联

**修改文件**: `server/services/functionalTestCaseService.ts`

**新增功能**:
- 在 `saveExecutionResult()` 方法中，保存功能测试执行结果时，同时创建 `test_run_results` 记录
- 新增 `createTestRunResultForFunctionalTest()` 方法：为功能测试创建 `test_run_results` 记录
- 新增 `findOrCreateTestRunForFunctionalTest()` 方法：查找或创建 `test_runs` 记录

**实现逻辑**:
1. 保存功能测试执行结果到 `functional_test_executions` 表（原有逻辑）
2. 查找或创建对应的 `test_cases` 记录
   - 使用功能测试用例的名称、系统、模块等信息
   - 如果不存在，创建新的 `test_cases` 记录
3. 查找或创建 `test_runs` 记录
   - 使用"功能测试套件"作为默认套件
   - 同一天、同一执行者的测试使用同一个 `test_runs` 记录
4. 创建 `test_run_results` 记录
   - 映射状态：'pass' → 'PASSED'，'fail' → 'FAILED'，'block' → 'SKIPPED'

## 数据流程

### UI自动化测试执行流程
```
TestExecutionService.runTest()
  ↓
测试执行完成
  ↓
syncFromTestRun() → test_case_executions 表
  ↓
createTestRunResult() → test_run_results 表 ✅ 新增
  ↓
报告系统可以读取数据 ✅
```

### 功能测试执行流程
```
FunctionalTestCaseService.saveExecutionResult()
  ↓
functional_test_executions 表
  ↓
createTestRunResultForFunctionalTest() → test_run_results 表 ✅ 新增
  ↓
报告系统可以读取数据 ✅
```

## 关键特性

1. **避免重复创建**: 检查是否已存在 `test_run_results` 记录，避免重复创建
2. **自动创建关联记录**: 自动创建 `test_runs` 和 `test_cases` 记录（如果不存在）
3. **状态映射**: 正确映射不同系统的状态值
4. **错误处理**: 创建 `test_run_results` 失败不会影响主流程（静默失败）

## 测试验证

执行以下测试后，报告系统应该能显示数据：

1. **UI自动化测试**:
   - 执行任意测试用例
   - 检查 `test_run_results` 表是否有新记录
   - 检查报告页面是否显示数据

2. **功能测试**:
   - 保存功能测试执行结果
   - 检查 `test_run_results` 表是否有新记录
   - 检查报告页面是否显示数据

## 注意事项

1. **默认测试套件**: 
   - UI自动化测试使用"默认测试套件"
   - 功能测试使用"功能测试套件"
   - 如果不存在，会自动创建

2. **test_cases 记录**:
   - 功能测试会自动创建对应的 `test_cases` 记录
   - 使用功能测试用例的名称、系统、模块等信息

3. **历史数据**:
   - 此修复只影响新执行的测试
   - 如果需要历史数据，需要运行数据迁移脚本

