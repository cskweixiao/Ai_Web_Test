# Git 提交说明

## 2024-12-24

### 修复：过滤文档中的base64图片，优化AI输入长度

**修改文件：**
- `server/routes/axure.ts`

**变更内容：**

#### 1. 文档图片过滤（核心优化）
- **HTML文件**：自动过滤 `<img>` 标签中的base64图片，替换为简单的位置标记
- **DOCX文件**：改用 `mammoth.convertToHtml()` 转换为HTML（保留文档结构），然后过滤base64图片
- **Markdown文件**：过滤 `![alt](data:image/...)` 和 HTML 格式的base64图片
- **PDF文件**：使用 `pdf-parse` 提取纯文本，本身不包含图片

#### 2. 图片过滤策略
- 识别并移除 `src="data:image/...;base64,..."` 格式的图片
- 识别并移除超长 src 属性（>1000字符，可能是base64）
- 替换为简洁标记：`<img src="[图片1: 描述]" alt="图片1" />`（HTML）
- 或：`![图片1]([图片1: 描述])`（Markdown）
- 保留图片的 alt 文本（如果有）

#### 3. 详细日志输出
```
🖼️  已过滤 N 个base64图片
📊 过滤前: XXX 字符，过滤后: YYY 字符
📉 减少: ZZZ 字符 (百分比%)
```

#### 4. 内容长度安全检查（备用方案）
- 在过滤图片后，如果内容仍然超过 200,000 字符，进行智能截断
- 保留开头70%和结尾30%的内容
- 添加提示标记和建议（拆分文档处理）

**解决的问题：**
- 修复了当上传的文档包含大量图片时，base64编码导致内容超出AI模型限制的问题
- 错误信息：`Range of input length should be [1, 258048]`
- 根本原因：Word文档转HTML时，图片被转换为base64编码，单张图片可能几万到几十万字符

**技术细节：**
- **之前的方案**：使用 `mammoth.extractRawText()` 提取纯文本，丢失文档结构
- **优化后方案**：使用 `mammoth.convertToHtml()` 保留结构，过滤base64图片
- **过滤效果**：一张普通图片的base64编码约20,000-100,000字符，过滤后仅20-30字符
- **AI模型限制**：258,048 字符（系统提示词+用户提示词）
- **安全阈值**：200,000 字符（为系统提示词预留约58,000字符空间）

**影响范围：**
- 所有通过文件上传生成需求文档的功能（HTML、DOCX、Markdown、PDF）
- ✅ 所有通过文本粘贴生成需求文档的功能（已修复遗漏）

**优势：**
1. ✅ 保留文档结构和格式
2. ✅ 标记图片位置，AI能理解图片的上下文
3. ✅ 大幅减少输入长度（图片多的文档可减少90%+）
4. ✅ 避免简单粗暴的截断，保持内容完整性
5. ✅ 详细的日志便于诊断和优化

---

### 🔧 修复记录

**2024-12-24 第二次修复：完善文本输入的图片过滤**

**问题：**
- 第一次修复只在文件上传路径中添加了图片过滤
- 遗漏了 `/api/v1/axure/generate-from-text` 接口的文本输入图片过滤
- 用户通过文本粘贴功能输入包含base64图片的内容时，仍然会超出限制

**修复内容：**
- 在 `/generate-from-text` 接口中添加完整的图片过滤逻辑（第1044-1082行）
- 支持过滤Markdown格式：`![alt](data:image/...)`
- 支持过滤HTML格式：`<img src="data:image/...">`
- 与文件上传路径的过滤逻辑保持一致

**测试用例：**
```json
{
  "text": "文本内容...\n\n![图片](data:image/png;base64,iVBORw0KGgoAAAA...很长的base64)\n\n更多文本...",
  "systemName": "系统名称",
  "moduleName": "模块名称"
}
```

**预期结果：**
```
🖼️  【文本图片过滤】检测到并过滤了base64图片
   - 图片数量: 1 个
   📊 过滤前: 50000 字符
   📊 过滤后: 200 字符
   📉 减少: 49800 字符 (99.6%)
```

**前端响应增强：**
现在后端会在响应中返回过滤信息：
```json
{
  "success": true,
  "data": {
    "sessionId": "...",
    "requirementDoc": "...",
    "sections": [...],
    "contentSourceType": "text",
    "filterInfo": {
      "imagesFiltered": 8,
      "originalLength": 1057392,
      "filteredLength": 4149,
      "reductionPercent": "99.6"
    }
  }
}
```

这样前端可以：
1. 知道内容被过滤了
2. 显示过滤统计给用户
3. 提示用户：虽然你发送了很大的文件，但我们已经优化处理了

