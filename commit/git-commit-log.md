# Git 提交记录总结

本文档汇总了所有开发过程中的代码提交记录，按日期和功能模块分类整理。

---

## 2024-12-27

### 测试计划执行功能完善

#### 继续执行和重新执行功能
- **区分继续执行和重新执行两种模式**
  - 继续执行（cancelled/running状态）：保留历史数据，只执行未完成的用例
  - 重新执行（completed状态）：完全重置所有数据，执行所有用例
  - 修复继续执行时完全恢复已完成用例的执行状态（包括stepResults）
  - 修复继续执行时传递所有用例以便在执行页面显示完整列表
  - 修复继续执行状态同步和测试计划列表状态显示
  - 修复继续执行时未重置执行进度和时间字段的问题

#### 执行状态和时间管理
- **修复执行历史running状态缺少实时耗时和刷新后数据未更新的问题**
  - 后端自动根据execution_results同步更新started_at、finished_at、duration_ms
  - running状态的执行记录实时显示已运行时长（前端计算）
  - 执行详情弹窗正确检测数据变化并更新界面
- **修复时间字段精度问题**
  - 修复test_plan_executions时间字段精度问题（Timestamp(0)改为Timestamp(3)）
  - 修复执行详情查询时覆盖原始时间和耗时数据的问题
  - 确保重新执行时同步更新test_plan_executions的时间字段
  - 修复返回上一个用例后执行时长应重新计时

#### 执行流程优化
- **修复跳过用例导致执行记录被误删除的问题**
  - 跳过用例时标记已提交结果防止执行记录被删除
- **修复中途退出执行时缺失时间字段的问题**
  - 退出确认时保存完整的执行结果时间字段
- **修复超时自动取消时缺失duration_ms的问题**
  - 超时自动取消执行记录时正确计算耗时
- **增强执行状态更新支持和调试日志**
  - 支持更新started_at字段并添加调试日志
- **修复重新执行逻辑完全重置执行状态**
  - 重新执行时完全重置所有执行结果和统计数据
  - 修复重新执行时用例数量不正确的问题

---

## 2024-12-26

### 测试计划执行功能增强

#### 执行状态和结果管理
- **用例执行完成后自动更新测试计划状态 + 执行详情WebSocket实时更新**
  - 添加updateTestPlanStatusFromLatestExecution函数，自动更新test_plans表状态
  - TestPlanExecutionLogModal添加WebSocket监听和轮询机制实时更新执行详情
- **扩展执行详情存储实际执行状态（execution_status）**
  - 后端返回execution_status（UI自动化用例）
  - 前端构建execution_status（功能测试用例）
  - 前端显示实际状态，支持：执行中、已完成、已失败、已取消、执行错误、排队中
- **修复UI自动化用例执行详情缺少步骤统计数据的问题**
  - waitForTestCompletion函数返回步骤统计
  - syncToTestPlanExecution添加步骤统计
- **修复UI自动化测试断言步骤成功后未计入passedSteps导致结果被误判为block的问题**
  - 断言步骤成功后更新passedSteps

#### 单个用例执行优化
- **修复单个UI自动化用例执行时执行历史记录不完整的问题**
  - 统一执行逻辑，使用autoExecute: true
  - 统一切换到执行历史tab，查看执行进度
- **优化并增强单个UI自动化用例执行时的数据获取逻辑**
  - 增强日志系统，添加详细日志
  - 修复执行时间获取逻辑
  - 增强决策逻辑可见性
  - 完善统计信息
- **实现单个用例执行时自动同步结果到测试计划执行记录**
  - 恢复单个用例执行跳转详情页逻辑，传递planExecutionId
  - runTestCase方法增加planExecutionId参数
  - 测试完成时自动同步结果到test_plan_executions表

#### 执行配置和路由修复
- **修复后端路由未接收autoExecute参数导致的执行重复问题**
  - 添加autoExecute和executionConfig类型定义
  - 后端路由正确接收参数
  - 根据autoExecute参数决定是否自动执行

#### UI优化
- **为执行状态添加背景色显示**
  - getExecutionStatusText函数返回带背景色的Tag组件
- **修复：last_execution.status应从execution_results中获取**
  - 优先从result.execution_status获取每个用例的执行状态

#### 执行流程功能
- **feat: 添加测试计划执行中途退出确认功能**
  - 添加popstate事件监听阻止浏览器后退按钮
  - 添加beforeunload事件监听阻止页面关闭/刷新
  - 添加退出确认弹窗组件，显示当前执行进度
  - 确认退出时更新执行状态为cancelled，保存已完成的执行结果
- **feat: 添加测试计划继续执行功能**
  - 对于中途退出或取消的测试计划执行，可以在执行历史中点击"继续"按钮继续执行未完成的用例
  - 继续执行模式下复用之前的执行记录ID
  - 获取之前执行详情并恢复已完成用例的状态

#### 测试计划详情页面优化
- **2025-12-26 测试计划详情页面离开确认和自动清理超时执行记录**
  - 添加isExecutingLocally本地状态跟踪正在执行的操作
  - beforeunload事件处理器使用navigator.sendBeacon发送取消请求
  - 新增handleBackToList函数，在有活跃执行时弹出确认对话框
  - 在getTestPlanDetail中添加自动清理逻辑，超过2分钟的queued执行记录自动标记为cancelled

#### 功能用例执行优化
- **fix: 修复功能用例批量执行跳过时执行结果数据不完整的问题**
  - 重构handleSkipCurrentCase中executionResults构建逻辑
  - 为跳过的用例添加时间字段
  - 统一所有分支的时间字段处理
- **fix: 修复测试用例执行时间记录不准确的问题**
  - 添加caseStartTimeRef跟踪当前用例开始时间
  - 在loadCaseDetails函数中记录开始时间
  - 修改handleSaveCurrentCase和handleSkipCurrentCase使用真实时间
- **fix: 修复测试计划执行总耗时计算错误的问题**
  - 使用executionResults.reduce()累加每条用例的duration_ms
- **fix: 修复执行详情查询时覆盖原始时间和耗时数据的问题**
  - 优先保留原始result中的值，只在缺失时才使用数据库值

#### 性能优化
- **perf: 优化WebSocket/轮询刷新导致的页面闪烁问题**
  - 区分首次加载和刷新更新
  - 静默刷新模式
  - 添加局部刷新指示器
  - 数据对比优化

#### 其他修复
- **fix: 修复Ant Design bodyStyle已弃用警告**
  - 将所有使用bodyStyle的地方替换为styles属性
- **fix: 从执行历史tab继续执行后返回应保持在执行历史tab**
  - 在导航URL中添加fromTab参数
  - 返回时携带activeTab状态

### 测试计划UI自动化用例执行流程优化

- **修复UI自动化执行流程和统计数据准确性**
  - 恢复执行配置对话框，修复返回逻辑，修改详情打开方式
  - 添加waitForTestCompletion函数，修复执行结果统计
  - 执行详情表格中点击"日志"按钮，UI自动化用例在新标签页打开详细日志
- **优化测试计划UI自动化用例执行流程**
  - 单个UI自动化用例执行后跳转到测试执行详情页
  - 批量/全部UI自动化执行后提示并跳转到执行历史tab
  - UI自动化执行历史和统计数据正确展示
- **功能用例选择模态框添加"已关联"标记**
- **修复UI自动化用例选择模态框显示问题和筛选器配置**
- **修复添加UI自动化用例时版本信息无法显示的问题**
- **为UI自动化用例添加case_type字段支持**
- **修复UI自动化用例版本字段无法获取的问题**

---

## 2024-12-25

### 测试计划功能完善

- **测试计划详情页添加UI自动化用例执行配置功能**
- **优化UI自动化测试计划用例数据获取和显示**
- **完善测试计划搜索栏计划结果筛选功能**
- **修复测试计划删除确认对话框React渲染错误**
- **修复测试计划状态选项不一致问题**
- **测试计划列表统一样式，添加通过、失败、阻塞、计划结果列**
- **测试计划列表新增计划进度列**

### 测试用例和执行功能

- **支持测试用例ID搜索**
- **修复测试执行筛选功能，改为精确匹配并统一执行结果值格式**
- **过滤已删除用例的测试运行记录**
- **修复测试执行筛选功能，添加分页重置逻辑**
- **修复测试用例模块搜索栏所有筛选功能（状态、创建者、执行状态、执行结果）**
- **修复测试用例模块搜索栏执行状态和执行结果筛选功能**
- **统一执行结果和执行状态的命名规范**
- **测试用例和测试执行模块新增执行状态和执行结果筛选**
- **完整实现测试用例执行结果统计**
- **修复测试用例统计数据栏显示内容（已废弃）**
- **调整搜索栏位置到统计数据栏下方**
- **优化测试用例Tab布局结构，参考测试执行页面排版**
- **为测试用例Tab添加3种视图模式切换**
- **优化测试执行页面布局，参考功能用例页面排版**
- **修复TestRunsTable复选框勾选时的页面抖动问题**
- **为测试执行页面添加完整的筛选功能**
- **优化测试执行页面UI布局和按钮位置**
- **为测试执行页面添加搜索和筛选功能**
- **在测试用例页面新增测试执行标签页**

### 测试运行功能

- **修复测试运行表格排序功能**
- **修复前后端排序不一致问题**
- **修复表格视图宽度和滚动问题**
- **修复UI自动化测试计划用例执行和统计问题**
- **修复测试计划用例列表实时更新和执行历史时长精度问题**
- **确保测试计划用例执行状态和结果完全基于执行历史**
- **优化测试计划用例列表实时更新机制**
- **修复单个UI自动化用例执行时数据来源问题**
- **修复单个用例执行时重复调用接口的问题**
- **优化测试计划执行历史记录创建机制**

---

## 2024-12-24

### 测试运行功能优化

- **修复：测试运行列表排序功能未生效**
  - 后端支持动态排序参数（sortBy、sortOrder）
  - 前端传递排序参数到后端
  - 支持按startedAt或finishedAt排序，支持升序/降序

- **修复：测试运行时间无法正常显示的问题**
  - 修复字段名不一致问题（startTime/endTime → startedAt/finishedAt）
  - 增强safeFormat函数支持Date对象和ISO字符串两种格式
  - 更新接口定义和排序逻辑

- **重构：统一测试运行时间字段，简化API返回数据**
  - 删除冗余字段（startTime、endTime、actualStartedAt、endedAt）
  - 统一使用startedAt和finishedAt字段
  - 前后端字段完全一致

- **修复：测试运行列表时间显示错误和排序功能**
  - 优化TestRuns.tsx数据加载逻辑，使用testService.getAllTestRuns()方法
  - 修复时间字段使用优先级（优先使用startedAt）
  - 添加自动排序功能（默认按startedAt降序）

- **功能增强：测试运行列表支持前端排序**
  - getAllTestRuns()方法支持可选的排序参数
  - 可按startedAt、finishedAt、startTime字段排序
  - 支持升序（asc）或降序（desc）排列

- **优化：测试运行进度条增加动画效果**
  - 运行中的测试进度条显示从左到右滑动的渐变动画
  - 使用蓝色到浅蓝色的渐变效果
  - 修复Tailwind配置格式兼容性问题
  - 修复进度条动画不显示问题

### 开发环境优化

- **修复：解决开发服务器热重载失效和端口占用问题**
  - 创建智能开发服务器启动脚本（scripts/dev-server.cjs）
  - 自动端口清理功能
  - 优雅关闭处理
  - 跨平台支持（Windows和Unix）
  - 增强服务器错误处理

### 缓存统计功能

- **优化：修复缓存统计页面数据显示问题**
  - 修复趋势图数据显示问题
  - 统一hitRate数据类型处理
  - 优化饼图数据处理
  - 代码重构和优化

### 文档处理功能

- **修复：过滤文档中的base64图片，优化AI输入长度**
  - HTML文件：自动过滤<img>标签中的base64图片
  - DOCX文件：改用mammoth.convertToHtml()转换为HTML，然后过滤base64图片
  - Markdown文件：过滤base64图片
  - PDF文件：使用pdf-parse提取纯文本
  - 完善文本输入的图片过滤（第二次修复）

---

## 总结

本次开发周期主要完成了以下功能模块：

### 核心功能
1. **测试计划执行功能**：继续执行、重新执行、中途退出确认、实时状态更新
2. **测试计划UI自动化用例**：执行配置、执行流程优化、统计数据准确性
3. **测试用例和执行**：筛选功能、统计功能、视图模式切换
4. **测试运行**：排序功能、时间显示、进度条动画

### 技术优化
1. **开发环境**：热重载修复、端口占用处理
2. **性能优化**：WebSocket/轮询刷新优化、页面闪烁问题
3. **数据精度**：时间字段精度修复、执行耗时计算优化
4. **代码质量**：统一字段命名、修复弃用警告、增强错误处理

### 用户体验
1. **实时更新**：WebSocket实时更新执行状态
2. **视觉反馈**：进度条动画、状态标签背景色
3. **操作流程**：继续执行、重新执行、退出确认
4. **数据准确性**：执行结果统计、时间记录、步骤统计

---

**提交记录总数**：约80+个功能点和修复点

**涉及文件**：
- 前端：`src/pages/TestPlanDetail.tsx`、`src/pages/TestPlanExecute.tsx`、`src/components/TestPlanExecutionLogModal.tsx`等
- 后端：`server/services/testPlanService.ts`、`server/services/testExecution.ts`、`server/routes/testPlan.ts`等
- 配置：`prisma/schema.prisma`、`tailwind.config.cjs`、`scripts/dev-server.cjs`等

