/**
 * è¿™æ˜¯é›†æˆçŸ¥è¯†åº“åçš„ functionalTestCaseAIService.ts ç¤ºä¾‹ä»£ç 
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. å°†æ­¤æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ° functionalTestCaseAIService.ts çš„ generateBatch æ–¹æ³•ä¸­
 * 2. åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  import
 * 3. åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ– knowledgeBase
 */

// ============ Step 1: åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  import ============
import { TestCaseKnowledgeBase } from './testCaseKnowledgeBase';

// ============ Step 2: åœ¨ç±»ä¸­æ·»åŠ å±æ€§ ============
export class FunctionalTestCaseAIService {
  private knowledgeBase: TestCaseKnowledgeBase;

  constructor() {
    // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç ...

    // åˆå§‹åŒ–çŸ¥è¯†åº“
    this.knowledgeBase = new TestCaseKnowledgeBase();
  }

  // ============ Step 3: ä¿®æ”¹ generateBatch æ–¹æ³• ============
  async generateBatch(
    batchId: string,
    scenarios: string[],
    requirementDoc: string,
    existingCases: TestCase[]
  ): Promise<TestCase[]> {
    const sectionId = scenarios[0];
    console.log(`ğŸ¤– å¼€å§‹ç”Ÿæˆæ‰¹æ¬¡ ${batchId}ï¼ˆç« èŠ‚ ${sectionId}ï¼‰`);

    // æå–ç« èŠ‚å†…å®¹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    const sectionRegex = new RegExp(`###\\s+${sectionId.replace('.', '\\.')}\\s+(.+?)[\\s\\S]*?(?=###\\s+[\\d.]+\\s+|$)`);
    const sectionMatch = requirementDoc.match(sectionRegex);
    const sectionContent = sectionMatch ? sectionMatch[0] : requirementDoc.substring(0, 3000);
    const sectionName = sectionMatch ? sectionMatch[1].trim() : 'åŠŸèƒ½æ¨¡å—';

    console.log(`ğŸ“„ æå–ç« èŠ‚å†…å®¹ - ${sectionId} ${sectionName} (${sectionContent.length}å­—ç¬¦)`);

    // ============ ğŸ”¥ æ–°å¢ï¼šä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³çŸ¥è¯† ============
    console.log('ğŸ” æ­£åœ¨ä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³çŸ¥è¯†...');

    const knowledgeResults = await this.knowledgeBase.searchByCategory({
      query: sectionContent,
      businessDomain: this.projectInfo?.businessDomain,  // ä½¿ç”¨é¡¹ç›®ä¸šåŠ¡é¢†åŸŸ
      topK: 2  // æ¯ç±»çŸ¥è¯†å–Top 2ï¼Œæ§åˆ¶tokenæ¶ˆè€—
    });

    // æ„å»ºçŸ¥è¯†å¢å¼ºçš„Prompt
    const knowledgePrompt = this.buildKnowledgePrompt(knowledgeResults);
    console.log(`âœ… æ£€ç´¢åˆ°çŸ¥è¯†: ä¸šåŠ¡è§„åˆ™${knowledgeResults.businessRules.length}æ¡, æµ‹è¯•æ¨¡å¼${knowledgeResults.testPatterns.length}æ¡, è¸©å‘ç‚¹${knowledgeResults.pitfalls.length}æ¡, èµ„æŸåœºæ™¯${knowledgeResults.riskScenarios.length}æ¡`);

    // ============ åŸæœ‰çš„ systemPromptï¼ˆä¿æŒä¸å˜ï¼‰============
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è®¾è®¡ä¸“å®¶ã€‚ä½ çš„èŒè´£æ˜¯ï¼š
1. æ ¹æ®éœ€æ±‚æ–‡æ¡£çš„æŒ‡å®šç« èŠ‚ç”Ÿæˆè¯¦ç»†çš„åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
2. æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åŒ…å«ä¸€ä¸ªæµ‹è¯•ç›®çš„ï¼Œä»¥åŠè‹¥å¹²ä¸ªæµ‹è¯•ç‚¹
3. æ¯ä¸ªæµ‹è¯•ç‚¹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯éªŒè¯çš„æµ‹è¯•é¡¹
4. æ ¹æ®éœ€æ±‚å¤æ‚åº¦å†³å®šç”Ÿæˆçš„æµ‹è¯•ç‚¹æ•°é‡ï¼Œä¸è¦äººä¸ºé™åˆ¶æ•°é‡
5. é¿å…ä¸å·²å­˜åœ¨çš„æµ‹è¯•ç”¨ä¾‹é‡å¤

ğŸ¯ æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š
- ä¸€æ¡æµ‹è¯•ç”¨ä¾‹ = ä¸€ä¸ªæµ‹è¯•ç›®çš„ + å¤šä¸ªæµ‹è¯•ç‚¹
- æµ‹è¯•ç›®çš„ï¼šæ€»ä½“æµ‹è¯•ç›®æ ‡ï¼ˆå¦‚"éªŒè¯è®¢å•åˆ›å»ºæµç¨‹"ï¼‰
- æµ‹è¯•ç‚¹ï¼šå…·ä½“çš„æµ‹è¯•é¡¹ï¼ˆå¦‚"æ­£å¸¸æäº¤è®¢å•"ã€"åº“å­˜ä¸è¶³æ—¶æäº¤è®¢å•"ã€"è¶…æ—¶è®¢å•å¤„ç†"ï¼‰

ğŸ“Š æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆè§„åˆ™ï¼š
1. æ•°é‡ä¸é™åˆ¶ï¼šæ ¹æ®éœ€æ±‚æ–‡æ¡£çš„å¤æ‚åº¦è‡ªåŠ¨åˆ¤æ–­éœ€è¦å¤šå°‘ä¸ªæµ‹è¯•ç‚¹
2. æ¯ä¸ªæµ‹è¯•ç‚¹å¿…é¡»æ˜¯åŸå­æ€§çš„ã€ç‹¬ç«‹éªŒè¯çš„
3. æµ‹è¯•ç‚¹åº”è¦†ç›–æ­£å¸¸æµç¨‹ã€å¼‚å¸¸æµç¨‹ã€è¾¹ç•Œæ¡ä»¶
4. æµ‹è¯•ç‚¹åº”æ ‡æ³¨é£é™©ç­‰çº§ï¼ˆlow/medium/highï¼‰

æµ‹è¯•ç”¨ä¾‹ç»“æ„è¦æ±‚ï¼šï¼ˆä¿æŒåŸæœ‰æ ¼å¼ï¼‰
...
`;

    const existingCaseNames = existingCases.map(tc => tc.name).join('\n- ');

    // ============ ğŸ”¥ ä¿®æ”¹ï¼šåœ¨ userPrompt ä¸­æ³¨å…¥çŸ¥è¯†åº“å†…å®¹ ============
    const userPrompt = `è¯·ä¸ºä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ç« èŠ‚ç”Ÿæˆè¯¦ç»†çš„åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ï¼š

## ç›®æ ‡ç« èŠ‚
ç« èŠ‚ID: ${sectionId}
ç« èŠ‚åç§°: ${sectionName}

## ç« èŠ‚éœ€æ±‚å†…å®¹
${sectionContent}

${knowledgePrompt}  // ğŸ”¥ æ³¨å…¥çŸ¥è¯†åº“å†…å®¹

## å·²å­˜åœ¨çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆé¿å…é‡å¤ï¼‰
${existingCaseNames || 'æ— '}

## ç”Ÿæˆè¦æ±‚
1. æ ¹æ®éœ€æ±‚å¤æ‚åº¦å†³å®šæµ‹è¯•ç‚¹æ•°é‡ï¼Œä¸è¦äººä¸ºé™åˆ¶
2. æ¯ä¸ªæµ‹è¯•ç‚¹å¿…é¡»ç‹¬ç«‹ä¸”å¯éªŒè¯
3. è¦†ç›–æ­£å¸¸æµç¨‹ã€å¼‚å¸¸æµç¨‹ã€è¾¹ç•Œæ¡ä»¶
4. ç‰¹åˆ«å…³æ³¨ä¸Šè¿°ä¸šåŠ¡è§„åˆ™ã€è¸©å‘ç‚¹å’Œèµ„æŸåœºæ™¯
5. æ ‡æ³¨æ¯ä¸ªæµ‹è¯•ç‚¹çš„é£é™©ç­‰çº§
6. æµ‹è¯•ç”¨ä¾‹åç§°æ ¼å¼ï¼š[ç« èŠ‚ID]-[æµ‹è¯•ç›®çš„]

è¯·è¾“å‡ºJSONæ ¼å¼ï¼š
ï¼ˆä¿æŒåŸæœ‰æ ¼å¼ï¼‰
...
`;

    // å…¶ä½™ä»£ç ä¿æŒä¸å˜...
    try {
      const aiResponse = await this.callAI(systemPrompt, userPrompt, 8000);
      // ... è§£æå’Œè¿”å›é€»è¾‘
    } catch (error) {
      // ... é”™è¯¯å¤„ç†
    }
  }

  // ============ ğŸ”¥ æ–°å¢æ–¹æ³•ï¼šæ„å»ºçŸ¥è¯†å¢å¼ºPrompt ============
  private buildKnowledgePrompt(knowledgeResults: {
    businessRules: any[];
    testPatterns: any[];
    pitfalls: any[];
    riskScenarios: any[];
  }): string {
    let prompt = '\n## ğŸ“š ç›¸å…³çŸ¥è¯†å‚è€ƒï¼ˆæ¥è‡ªçŸ¥è¯†åº“ï¼‰\n\n';

    // ä¸šåŠ¡è§„åˆ™
    if (knowledgeResults.businessRules.length > 0) {
      prompt += '### ğŸ’¼ ä¸šåŠ¡è§„åˆ™\n';
      knowledgeResults.businessRules.forEach(rule => {
        prompt += `**${rule.knowledge.title}**ï¼ˆç›¸ä¼¼åº¦${(rule.score * 100).toFixed(0)}%ï¼‰\n`;
        prompt += `${rule.knowledge.content}\n\n`;
      });
    }

    // æµ‹è¯•æ¨¡å¼
    if (knowledgeResults.testPatterns.length > 0) {
      prompt += '### ğŸ“‹ æµ‹è¯•åœºæ™¯æ¨¡å¼\n';
      knowledgeResults.testPatterns.forEach(pattern => {
        prompt += `**${pattern.knowledge.title}**\n`;
        prompt += `${pattern.knowledge.content}\n\n`;
      });
    }

    // è¸©å‘ç‚¹
    if (knowledgeResults.pitfalls.length > 0) {
      prompt += '### âš ï¸ å†å²è¸©å‘ç‚¹ï¼ˆå¿…é¡»è¦†ç›–ï¼‰\n';
      knowledgeResults.pitfalls.forEach(pitfall => {
        prompt += `**${pitfall.knowledge.title}**\n`;
        prompt += `${pitfall.knowledge.content}\n\n`;
      });
    }

    // èµ„æŸåœºæ™¯
    if (knowledgeResults.riskScenarios.length > 0) {
      prompt += '### ğŸ”¥ èµ„æŸåœºæ™¯ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰\n';
      knowledgeResults.riskScenarios.forEach(risk => {
        prompt += `**${risk.knowledge.title}**\n`;
        prompt += `${risk.knowledge.content}\n\n`;
      });
    }

    if (prompt === '\n## ğŸ“š ç›¸å…³çŸ¥è¯†å‚è€ƒï¼ˆæ¥è‡ªçŸ¥è¯†åº“ï¼‰\n\n') {
      return '';  // å¦‚æœæ²¡æœ‰æ£€ç´¢åˆ°ä»»ä½•çŸ¥è¯†ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    }

    prompt += '**è¯·å‚è€ƒä»¥ä¸ŠçŸ¥è¯†ï¼Œç¡®ä¿ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹è¦†ç›–ç›¸å…³ä¸šåŠ¡è§„åˆ™ã€æµ‹è¯•åœºæ™¯ã€è¸©å‘ç‚¹å’Œèµ„æŸåœºæ™¯ã€‚**\n';

    return prompt;
  }
}
