# 🔥 通用断言验证框架设计文档

## 概述

本框架旨在通过AI自动解析和适配大多数自然语言描述的断言场景，提供灵活的验证策略和回退机制。

## 核心设计理念

### 1. 断言类型识别

系统能够自动识别以下断言类型：

- **存在性验证**（宽松）："存在"、"有"、"包含"、"显示"
- **内容验证**（严格/宽松）："是"、"等于"、"为"、"包含"
- **可见性验证**（严格）："可见"、"隐藏"
- **状态验证**（严格）："已选中"、"已启用"、"已禁用"
- **数量验证**（严格）："有X条"、"共X个"
- **属性验证**（严格）："值为"、"属性为"

### 2. 验证策略层次

#### 严格验证（Strict）
- 必须找到特定元素
- 必须精确匹配验证值
- 不允许回退到其他元素
- 适用于：精确匹配、状态验证、数量验证

#### 宽松验证（Loose）
- 优先查找特定元素
- 支持部分匹配
- 允许回退到同类元素
- 适用于：存在性验证、内容包含验证

#### 灵活验证（Flexible）
- 找不到特定元素时，查找同类元素
- 只要找到符合条件的内容即可通过
- 适用于："存在内容"类型的断言

### 3. 元素查找策略（多层回退）

1. **精确匹配**：通过element描述和ref精确找到元素
2. **模糊匹配**：通过element描述的关键词找到元素
3. **类型匹配**：如果找不到特定元素，查找同类元素（如所有输入框）
4. **全局查找**：在整个页面中查找

### 4. 验证执行策略

#### 对于"存在内容"类型的断言
- **查找阶段**：
  - 优先查找特定元素（如"搜索输入框"）
  - 如果找不到，查找所有有内容的输入框
  - 只要找到任何一个有内容的输入框，就认为找到元素

- **验证阶段**：
  - 如果指定了value，优先检查是否包含
  - 如果value不匹配但元素有内容，对于"存在内容"类型也认为通过
  - 如果没有指定value，只要有内容就通过

## 工作流程

### 1. AI解析阶段

```
断言描述 → AI分析 → 结构化断言信息
  ↓
- element: 元素描述
- ref: 元素引用（可选）
- condition: 验证条件
- value: 验证值（可选）
```

### 2. 元素查找阶段

```
精确查找 → 模糊查找 → 类型查找 → 全局查找
  ↓           ↓           ↓           ↓
成功       成功       成功       成功/失败
```

### 3. 验证执行阶段

```
获取元素内容 → 判断断言类型 → 执行验证策略
  ↓              ↓                ↓
输入框值/文本   存在性/内容/...   严格/宽松/灵活
```

## 断言类型适配示例

### 示例1: "搜索输入框存在默认搜索内容"
- **类型**：存在性验证（宽松）
- **策略**：
  1. 查找"搜索输入框"
  2. 如果找不到，查找所有有内容的输入框
  3. 验证：只要找到有内容的输入框就通过（即使value不完全匹配）

### 示例2: "提交按钮可见"
- **类型**：可见性验证（严格）
- **策略**：
  1. 必须找到"提交按钮"
  2. 验证：元素必须可见

### 示例3: "标题文本为'欢迎使用'"
- **类型**：内容验证（严格）
- **策略**：
  1. 必须找到"标题"
  2. 验证：文本必须精确匹配"欢迎使用"

### 示例4: "输入框存在内容"
- **类型**：存在性验证（灵活）
- **策略**：
  1. 优先查找"输入框"
  2. 如果找不到，查找所有有内容的输入框
  3. 验证：只要找到有内容的输入框就通过

## 关键改进点

1. **AI系统提示词增强**：
   - 识别更多断言类型
   - 理解验证策略和回退机制
   - 返回结构化断言信息

2. **元素查找逻辑增强**：
   - 多层回退机制
   - 支持同类元素查找
   - 智能识别元素类型

3. **验证执行逻辑增强**：
   - 根据断言类型选择验证策略
   - 支持宽松验证（"存在内容"类型）
   - 智能判断验证严格程度

## 扩展性

框架设计支持轻松扩展：

1. **新增断言类型**：只需在AI提示词中添加识别规则
2. **新增验证条件**：在playwrightTestRunner中添加处理逻辑
3. **新增回退策略**：在元素查找逻辑中添加新的查找方式

## 使用建议

1. **断言描述要清晰**：明确指定要验证的元素和内容
2. **使用自然语言**：系统会自动识别断言类型
3. **利用回退机制**：对于"存在"类断言，系统会自动回退查找

