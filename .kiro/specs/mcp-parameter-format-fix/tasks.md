# MCP 参数格式修复实现任务

- [x] 1. 修复预解析分支的参数格式问题





  - 修改 `server/services/testExecution.ts` 中 `executeMcpCommand` 方法的预解析分支
  - 将 `{ selector, value }` 格式改为 `{ ref, text }` 格式
  - 添加元素查找逻辑调用 `findBestElement` 方法
  - 确保点击操作使用 `{ ref }` 参数，输入操作使用 `{ ref, text }` 参数
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 2. 修复动态解析分支的参数格式问题  

  - 修改 `server/services/testExecution.ts` 中 `executeMcpCommand` 方法的动态解析分支
  - 在输入操作处理中添加 `findBestElement` 调用
  - 将参数格式从 `{ selector, value }` 改为 `{ ref, text }`
  - 在点击操作处理中确保使用 `{ ref }` 参数格式
  - _需求: 3.1, 3.2, 3.3_

- [x] 3. 创建统一的元素查找和参数转换辅助方法




  - 在 `TestExecutionService` 类中添加 `findElementAndBuildCommand` 辅助方法
  - 实现统一的参数格式转换逻辑
  - 添加参数格式验证和错误处理
  - 确保方法可以处理不同类型的操作（点击、输入、等待）
  - _需求: 1.3, 2.1, 3.1_

- [x] 4. 增强错误处理和日志记录


  - 添加元素查找失败的详细错误信息
  - 改进 MCP 工具调用的日志输出格式
  - 添加参数格式转换前后的对比日志
  - 实现错误恢复和回退机制
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 5. 添加参数格式转换的单元测试


  - 创建测试文件 `server/services/__tests__/mcpParameterFormat.test.ts`
  - 编写参数格式转换的测试用例
  - 测试元素查找功能的正确性
  - 验证错误处理逻辑的有效性
  - _需求: 1.1, 1.2, 2.2, 3.2_

- [x] 6. 验证修复效果和回归测试


  - 运行现有的测试用例确保无回归问题
  - 创建专门的 MCP 参数格式测试用例
  - 验证浏览器操作（输入、点击）能够正常执行
  - 检查 MCP 工具调用日志的正确格式
  - _需求: 4.1, 4.2, 4.3, 1.1, 1.2_

- [x] 7. 更新相关文档和注释



  - 更新代码注释说明参数格式的变更
  - 在 MCP 执行流程文档中记录修复内容
  - 添加参数格式规范的文档说明
  - 更新错误处理和调试指南
  - _需求: 5.1, 5.2, 4.4_