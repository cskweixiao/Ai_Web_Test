# 实施计划

- [x] 1. 数据库模型和迁移设置









  - 更新Prisma schema添加step_screenshots表和枚举类型
  - 创建数据库迁移脚本
  - 验证数据库表结构和索引
  - _需求: 1.2, 2.1_

- [x] 2. ScreenshotService服务类实现







  - [x] 2.1 创建ScreenshotService基础类和接口定义


    - 定义ScreenshotRecord接口和相关类型
    - 实现ScreenshotService类的基本结构
    - 添加Prisma客户端依赖注入
    - _需求: 1.1, 2.1_



  - [x] 2.2 实现截图保存功能



    - 编写saveScreenshot方法保存截图记录到数据库
    - 实现文件大小获取和验证逻辑
    - 添加错误处理和日志记录
    - 创建单元测试验证保存功能
    - _需求: 1.1, 1.2_

  - [x] 2.3 实现截图查询功能




    - 编写getScreenshotsByRunId方法按运行ID查询截图
    - 实现getStepScreenshot方法查询特定步骤截图
    - 添加查询结果排序和分页支持
    - 创建单元测试验证查询功能
    - _需求: 2.1, 2.2_

- [x] 3. 增强TestExecutionService集成截图功能




  - [x] 3.1 修改takeStepScreenshot方法


    - 更新方法签名支持数据库存储
    - 集成ScreenshotService调用
    - 添加文件信息获取逻辑
    - 保持向后兼容性
    - _需求: 1.1, 1.3_

  - [x] 3.2 更新测试执行流程


    - 在TestExecutionService构造函数中注入ScreenshotService
    - 修改所有截图调用点使用新的方法
    - 添加截图失败时的错误处理
    - 确保测试执行不因截图失败而中断
    - _需求: 1.3, 3.2_

- [x] 4. 实现文件管理功能





  - [x] 4.1 文件存在性验证

    - 实现verifyScreenshotFile方法检查文件是否存在
    - 添加批量文件验证功能
    - 更新数据库中的file_exists字段
    - 创建定期验证任务
    - _需求: 2.3, 3.3_

  - [x] 4.2 过期截图清理功能


    - 实现cleanupExpiredScreenshots方法
    - 添加配置支持设置保留天数
    - 实现安全的文件删除逻辑
    - 添加清理统计和日志记录
    - _需求: 3.1, 3.2_

- [x] 5. API接口实现









  - [x] 5.1 截图查询API




    - 创建GET /api/test-runs/:runId/screenshots接口
    - 实现GET /api/test-runs/:runId/screenshots/:stepIndex接口
    - 添加响应格式化和错误处理
    - 创建API集成测试
    - _需求: 2.1, 2.2, 4.2_

  - [x] 5.2 截图文件服务API







    - 实现GET /api/screenshots/:filename文件下载接口
    - 添加文件类型验证和安全检查
    - 实现缓存头和条件请求支持
    - 处理文件不存在的情况
    - _需求: 4.2, 2.3_

  - [x] 5.3 管理功能API


    - 创建DELETE /api/screenshots/cleanup清理接口
    - 实现GET /api/screenshots/stats统计接口
    - 添加管理员权限验证
    - 创建管理功能的集成测试
    - _需求: 3.1, 3.2_

- [x] 6. 存储统计和监控



  - [x] 6.1 实现存储统计功能


    - 编写getStorageStats方法计算存储统计
    - 实现文件大小汇总和平均值计算
    - 添加缺失文件检测统计
    - 创建统计数据的单元测试
    - _需求: 3.2, 3.3_

  - [x] 6.2 添加监控和告警


    - 实现存储空间使用监控
    - 添加文件丢失检测和告警
    - 创建性能指标收集
    - 集成到现有的监控系统
    - _需求: 3.2, 3.3_

- [x] 7. 测试和验证




  - [x] 7.1 单元测试完善


    - 为ScreenshotService编写完整的单元测试
    - 测试所有错误处理分支
    - 添加边界条件和异常情况测试
    - 确保测试覆盖率达到90%以上
    - _需求: 1.1, 1.2, 1.3_


  - [x] 7.2 集成测试实现

    - 创建完整的截图保存流程集成测试
    - 测试API接口的正确性和性能
    - 验证文件清理功能的安全性
    - 测试数据库事务和并发处理
    - _需求: 2.1, 2.2, 3.1_

- [x] 8. 部署和配置




  - [x] 8.1 数据库迁移部署


    - 执行Prisma迁移创建新表
    - 验证生产环境数据库结构
    - 创建索引优化查询性能
    - 备份现有数据确保安全
    - _需求: 1.2, 2.1_

  - [x] 8.2 应用配置和部署


    - 更新环境配置添加截图相关设置
    - 确保screenshots目录存在且有正确权限
    - 部署新版本应用代码
    - 验证功能在生产环境正常工作
    - _需求: 1.1, 3.2_