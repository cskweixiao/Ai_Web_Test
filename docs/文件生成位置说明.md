# 测试执行文件生成位置说明

本文档详细说明 MCP 模式和 Playwright Test Runner 模式执行测试用例后生成的文件及其存储位置。

## 目录结构概览

```
项目根目录/
├── screenshots/              # MCP 模式截图主目录
│   ├── {runId}-step-*.png    # 步骤截图文件
│   ├── backup/               # 截图备份目录
│   │   └── YYYY-MM-DD/       # 按日期分类
│   │       └── {runId}/      # 按运行ID分类
│   └── index/                 # 截图索引目录
│       └── {runId}_screenshots.json
├── artifacts/                 # 证据文件主目录（两种模式共用）
│   └── {runId}/              # 按运行ID分类
│       ├── *.png             # 截图文件
│       ├── {runId}-execution.log  # 执行日志
│       ├── {runId}-trace.zip      # Trace文件（仅Playwright模式）
│       └── {runId}-video-*.{ext}  # 视频文件（仅Playwright模式，如果启用）
└── test-results/             # Playwright Test Runner 可能生成的目录（如果启用）
```

---

## MCP 模式文件生成

### 1. 截图文件

#### 主目录
- **位置**: `{项目根目录}/screenshots/`
- **文件名格式**: `{runId}-step-{stepIndex}-{status}-{timestamp}.png`
- **示例**: `b90b82b9-a072-4d4a-9414-19c4cfb81fe9-step-1-success-1765352049906.png`

#### 备份目录（如果启用备份）
- **位置**: `{项目根目录}/screenshots/backup/{YYYY-MM-DD}/{runId}/`
- **说明**: 按日期和运行ID分类的备份副本
- **配置**: 通过 `screenshot-config.json` 中的 `enableBackup` 控制

#### 索引文件
- **位置**: `{项目根目录}/screenshots/index/{runId}_screenshots.json`
- **内容**: JSON格式，包含所有截图的元数据（步骤索引、文件名、描述、状态、时间戳等）

#### 证据目录（测试完成后复制）
- **位置**: `{项目根目录}/artifacts/{runId}/`
- **说明**: 测试完成后，所有截图会从 `screenshots/` 目录复制到 `artifacts/{runId}/` 目录
- **目的**: 统一管理所有测试证据

### 2. 日志文件

- **位置**: `{项目根目录}/artifacts/{runId}/{runId}-execution.log`
- **内容**: 包含所有测试执行日志，格式为 `[时间戳] [级别] 消息`
- **生成时机**: 测试完成后统一生成

### 3. 数据库记录

#### step_screenshots 表
- 存储每个步骤的截图记录
- 包含：runId, testCaseId, stepIndex, stepDescription, status, filePath, fileName, fileSize, mimeType, fileExists

#### run_artifacts 表
- 存储所有证据文件的记录（截图、日志等）
- 包含：runId, type, filename, size, createdAt

### 4. 其他文件

MCP 模式**不支持**自动生成以下文件：
- ❌ Trace 文件（.zip）
- ❌ 视频文件（.webm/.mp4）

---

## Playwright Test Runner 模式文件生成

### 1. 截图文件

- **位置**: `{项目根目录}/artifacts/{runId}/`
- **文件名格式**: 
  - 成功步骤: `step-{stepIndex}-success-{timestamp}.png`
  - 失败步骤: `step-{stepIndex}-failed-{timestamp}.png`
  - 最终截图: `final-completed-{timestamp}.png`
- **说明**: 直接保存到 artifacts 目录，不经过 screenshots 目录

### 2. Trace 文件（如果启用）

- **位置**: `{项目根目录}/artifacts/{runId}/{runId}-trace.zip`
- **生成条件**: `enableTrace !== false`（默认启用）
- **说明**: Playwright Trace Viewer 可以打开此文件进行调试
- **可能来源**: 
  - `test-results/` 目录
  - `playwright-report/` 目录
  - `artifacts/{runId}/` 目录
  - `traces/` 目录

### 3. 视频文件（如果启用）

- **位置**: `{项目根目录}/artifacts/{runId}/{runId}-video-{timestamp}.{ext}`
- **格式**: `.webm` 或 `.mp4`
- **生成条件**: `enableVideo !== false`（默认启用）
- **可能来源**:
  - `test-results/` 目录
  - `artifacts/{runId}/` 目录
  - `videos/` 目录

### 4. 日志文件

- **位置**: `{项目根目录}/artifacts/{runId}/{runId}-execution.log`
- **内容**: 包含所有测试执行日志
- **生成时机**: 测试完成后统一生成

### 5. 数据库记录

#### run_artifacts 表
- 存储所有证据文件的记录（截图、日志、trace、视频等）
- 包含：runId, type, filename, size, createdAt

**注意**: Playwright Test Runner 模式**不会**在 `step_screenshots` 表中保存截图记录，所有证据都通过 `run_artifacts` 表管理。

---

## 文件类型对照表

| 文件类型 | MCP 模式 | Playwright 模式 | 说明 |
|---------|---------|----------------|------|
| 步骤截图 | ✅ | ✅ | 两种模式都生成 |
| 最终截图 | ✅ | ✅ | 测试完成时生成 |
| 执行日志 | ✅ | ✅ | 测试完成后生成 |
| Trace 文件 | ❌ | ✅ | 仅 Playwright 模式支持 |
| 视频文件 | ❌ | ✅ | 仅 Playwright 模式支持（如果启用） |
| 截图备份 | ✅ | ❌ | 仅 MCP 模式支持 |
| 截图索引 | ✅ | ❌ | 仅 MCP 模式支持 |

---

## 配置说明

### 截图目录配置

默认配置位置：`{项目根目录}/screenshot-config.json`

```json
{
  "screenshotsDirectory": "./screenshots",
  "enableFileVerification": true,
  "enableAutoCleanup": true,
  "retentionDays": 30,
  "enableBackup": true,
  "backupDirectory": "./screenshots/backup",
  "logLevel": "info"
}
```

### 证据目录配置

- **默认位置**: `{项目根目录}/artifacts/`
- **配置位置**: `server/index.ts` 中 EvidenceService 初始化
- **环境变量**: 可通过 `BASE_URL` 环境变量配置签名URL的基础地址

---

## 文件访问

### 通过 API 访问

所有证据文件都可以通过以下 API 访问：

1. **获取文件列表**: `GET /api/evidence/{runId}/files`
2. **获取签名URL**: `GET /api/evidence/{runId}/sign/{filename}`
3. **下载文件**: `GET /api/evidence/download/{runId}/{filename}`

### 前端显示

前端通过 `EvidenceViewerNew` 组件显示所有证据文件，支持：
- 截图预览（网格/列表视图）
- 日志查看
- Trace 文件在线查看（通过 trace.playwright.dev）
- 文件下载

---

## 注意事项

1. **MCP 模式**: 截图先保存在 `screenshots/` 目录，测试完成后复制到 `artifacts/` 目录
2. **Playwright 模式**: 所有文件直接保存到 `artifacts/` 目录
3. **重复检查**: 系统会自动检查文件是否已存在，避免重复保存
4. **数据库记录**: 所有文件都会在数据库中记录，便于查询和管理
5. **清理策略**: 可以通过 `retentionDays` 配置自动清理过期文件

