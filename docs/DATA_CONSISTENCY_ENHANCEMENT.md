# 数据一致性进一步增强

## 📋 问题反馈

### 问题1：生成的测试用例数据和操作步骤依然不一致

**实例1**：
- 用例名称：包含"输入'admin'"
- 测试数据：显示"用户名：（空），密码：123456" ❌
- **问题**：名称说输入 admin，但数据显示用户名为空

**实例2**：
- 用例名称：某个关于密码为空的场景
- 操作步骤：第2步"在密码输入框中输入'123456'" ❌
- **问题**：密码应该为空，但步骤在输入密码

### 问题2：没有测试数据时，测试数据栏不显示

之前只有当有测试数据时才显示测试数据栏，导致用户看不到这个字段。

## ✅ 解决方案

### 1. 增强验证规则 - 更细致的一致性检查

#### 新增检查规则

**文件**: `server/services/functionalTestCaseAIService.ts`

```typescript
private validateTestCaseConsistency(testCase: TestCase) {
  // 检查1: 空值场景的深度检查
  const emptyFieldChecks = [
    { 
      field: '用户名', 
      keywords: ['用户名为空', '用户名不填', '不输入用户名', '未输入用户名'], 
      inputPatterns: ['输入用户名', '填写用户名', 'admin', 'user'] 
    },
    { 
      field: '密码', 
      keywords: ['密码为空', '密码不填', '不输入密码', '未输入密码'], 
      inputPatterns: ['输入密码', '填写密码', '123456', 'password'] 
    },
    // ... 其他字段
  ];

  // 检查空值标记
  if (isEmptyScenario) {
    // 1. 检查测试数据中是否正确标记为"（空）"
    // 2. 检查是否有具体值（如 admin、123456）
    // 3. 检查步骤中是否有输入操作
  }

  // 检查2: 非空场景必须有输入操作
  const notEmptyFieldChecks = [
    { 
      field: '用户名', 
      keywords: ['用户名不为空', '输入用户名', '填写用户名'], 
      inputPatterns: ['输入用户名', '填写用户名', 'admin', 'user'] 
    },
    // ...
  ];

  // 检查3: 步骤中的具体值必须在测试数据中列出
  const valuePatterns = [
    { value: 'admin', field: '用户名' },
    { value: '123456', field: '密码' }
  ];

  // 检查步骤中使用的值是否在测试数据中
}
```

#### 验证输出增强

```
🔍 [数据一致性验证] 检查生成的测试用例...

❌ [一致性问题] 用例 2: "用户名不为空，密码为空 - BOUNDARY"
   ⚠️ 用例名称表明"密码为空"，但测试数据中显示密码有具体值
   ⚠️ 用例名称表明"密码为空"，但操作步骤中在输入密码
   ⚠️ 操作步骤中使用了密码"123456"，但测试数据中未列出
   📋 用例信息:
      - 测试数据: 用户名：admin
      - 操作步骤预览: 1. 【操作】在密码输入框中输入'123456'...
```

### 2. 强化 AI 提示词 - 生成前就避免问题

#### 增强的一致性检查清单

```markdown
**检查清单（生成前必须逐项检查）：**
- [ ] 用例名称描述的场景与测试数据一致？
- [ ] 测试数据与操作步骤中使用的数据一致？
- [ ] 操作步骤是否真的在执行用例名称描述的场景？
- [ ] 预期结果是否符合用例名称描述的场景？
- [ ] 如果用例名称说"为空"，则测试数据必须标记为"（空）"，步骤中不能输入该字段
- [ ] 如果用例名称说"不为空"，则测试数据必须有具体值，步骤中必须输入该字段
- [ ] 步骤中使用的所有具体值（如 'admin'、'123456'）必须在测试数据中列出

**🔥 特别注意：**
- 如果测试数据字段为空，请在测试数据中明确标记为"字段名：（空）"
- 步骤中使用的任何具体数据（账号、密码、数字等）都必须在 testData 字段中完整列出
```

#### 示例说明增强

在 `generateBatch` 方法的提示词中：

```markdown
8. ⚠️ **数据一致性检查（生成前必须逐项检查）**：
   - 用例名称描述的场景与测试数据必须完全一致
   - 测试数据与操作步骤中使用的数据必须完全一致
   - 操作步骤必须真实执行用例名称描述的场景
   - 例如：用例名为"密码为空"，则：
     * testData 必须写："密码：（空）"
     * steps 中不能有"输入密码"或具体密码值
   - 例如：用例名为"用户名不为空"，则：
     * testData 必须写："用户名：admin"（具体值）
     * steps 中必须有"输入用户名'admin'"
   - 步骤中使用的所有具体值必须在 testData 中完整列出
```

### 3. 测试数据栏始终显示

#### 修改前

```tsx
{/* 只有当有测试数据时才显示 */}
{currentCase.testData && (
  <div className="bg-blue-50 rounded-lg p-4">
    <label>测试数据</label>
    <p>{currentCase.testData}</p>
  </div>
)}
```

#### 修改后

**文件**: `src/components/ai-generator/TestCaseDetailModal.tsx`

```tsx
{/* 测试数据 - 始终显示，没有数据时显示空状态 */}
<div className={`bg-blue-50 rounded-lg p-4 border border-blue-200 
  ${!currentCase.preconditions ? 'col-span-2' : ''}`}>
  <div className="flex items-center gap-2 mb-2">
    <FileText className="w-4 h-4 text-blue-600" />
    <label className="text-xs font-semibold text-blue-800 uppercase tracking-wide">
      测试数据
    </label>
  </div>
  {isEditing ? (
    <TextArea
      value={editedCase?.testData || ''}
      onChange={(e) => updateField('testData', e.target.value)}
      rows={4}
      placeholder="测试数据（如：用户名：admin，密码：123456）"
    />
  ) : (
    <div className="text-sm text-gray-800 leading-relaxed">
      {currentCase.testData ? (
        <p>{currentCase.testData}</p>
      ) : (
        <p className="text-gray-400 italic">无</p>
      )}
    </div>
  )}
</div>
```

#### 特性

- ✅ 始终显示测试数据栏
- ✅ 没有数据时显示"无"（灰色斜体）
- ✅ 编辑时有友好的提示文本
- ✅ 如果没有前置条件，测试数据栏占满整行

## 📊 验证规则详细说明

### 规则1：空值场景验证

| 用例名称关键词 | 测试数据要求 | 操作步骤要求 | 检查内容 |
|---------------|-------------|-------------|---------|
| "用户名为空" | `用户名：（空）` | ❌ 不能包含"输入用户名"或 'admin' | 检查测试数据和步骤 |
| "密码为空" | `密码：（空）` | ❌ 不能包含"输入密码"或 '123456' | 检查测试数据和步骤 |
| "手机号为空" | `手机号：（空）` | ❌ 不能包含"输入手机号"或数字 | 检查测试数据和步骤 |

### 规则2：非空场景验证

| 用例名称关键词 | 测试数据要求 | 操作步骤要求 | 检查内容 |
|---------------|-------------|-------------|---------|
| "用户名不为空" | `用户名：admin` | ✅ 必须包含"输入用户名'admin'" | 检查是否有输入操作 |
| "密码不为空" | `密码：123456` | ✅ 必须包含"输入密码'123456'" | 检查是否有输入操作 |

### 规则3：具体值验证

| 步骤中的值 | 测试数据要求 | 示例 |
|-----------|-------------|------|
| 'admin' | 必须在 testData 中列出 | `用户名：admin` |
| '123456' | 必须在 testData 中列出 | `密码：123456` |
| 任何具体数据 | 必须在 testData 中列出 | `金额：100元` |

## 🎯 正确示例

### 示例1：密码为空的边界用例

```json
{
  "name": "用户名不为空，密码为空 - BOUNDARY",
  "testData": "用户名：admin，密码：（空）",
  "steps": "1. 【操作】打开登录页面\n   【预期】页面正常加载\n2. 【操作】在用户名输入框中输入'admin'\n   【预期】用户名输入框接收输入\n3. 【操作】密码输入框保持为空，直接点击登录按钮\n   【预期】显示'密码不能为空'的错误提示"
}
```

✅ **一致性检查通过**：
- 用例名称说"密码为空"
- 测试数据明确标记"密码：（空）"
- 步骤中没有输入密码的操作
- 步骤中使用的 'admin' 在测试数据中列出

### 示例2：用户名为空的边界用例

```json
{
  "name": "用户名为空，密码不为空 - BOUNDARY",
  "testData": "用户名：（空），密码：123456",
  "steps": "1. 【操作】打开登录页面\n   【预期】页面正常加载\n2. 【操作】用户名输入框保持为空\n   【预期】用户名输入框为空\n3. 【操作】在密码输入框中输入'123456'，点击登录按钮\n   【预期】显示'用户名不能为空'的错误提示"
}
```

✅ **一致性检查通过**：
- 用例名称说"用户名为空"
- 测试数据明确标记"用户名：（空）"
- 步骤中没有输入用户名的操作
- 步骤中使用的 '123456' 在测试数据中列出

## 🚀 效果对比

### 修复前 ❌

```
测试数据: （栏位不显示或数据错乱）
步骤1: 输入用户名 'admin'
步骤2: 输入密码 '123456'  ← 但用例名称说"密码为空"！
```

### 修复后 ✅

```
测试数据: 用户名：admin，密码：（空）
步骤1: 打开登录页面
步骤2: 在用户名输入框中输入 'admin'
步骤3: 密码输入框保持为空，点击登录按钮
预期: 显示"密码不能为空"的错误提示
```

## 📝 后续建议

1. **监控验证日志**：每次生成后查看控制台的一致性警告
2. **及时修正**：发现问题后立即重新生成或手动修正
3. **反馈模式**：如果某类问题频繁出现，进一步调整提示词
4. **定期审查**：定期检查生成的用例质量，总结常见问题模式

