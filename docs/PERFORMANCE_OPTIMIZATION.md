# 🚀 Ai Web Test 性能优化指南

## 📊 性能分析

### 当前性能表现
根据您的API数据分析：

| 指标 | 数值 | 评价 |
|-----|------|------|
| API响应时间 | 0.5-1ms | ✅ 优秀 |
| AI Token生成速度 | 15-55 tps | ⚠️ 中等 |
| 平均测试执行时间 | 55-113秒 | ⚠️ 偏慢 |

### 性能瓶颈分析

**1. AI模型处理速度（主要瓶颈）**
- Token生成：15-55 tokens/秒
- 对于1500-2800 tokens的测试，需要30-120秒

**2. 浏览器自动化等待时间**
- 页面加载：2-5秒/页面
- 元素等待：最多5秒/元素
- 新页签检测：1.2秒

**3. 资源加载**
- 图片、CSS、字体等静态资源
- 可通过禁用非必要资源加速

---

## ⚡ 快速优化方案

### 方案一：启用快速模式（推荐）

**在 `.env` 文件中添加：**
```bash
# 切换到快速模式
PERFORMANCE_MODE=fast

# 禁用图片加载（提速30-50%）
PLAYWRIGHT_DISABLE_IMAGES=true

# 减少等待时间
DEFAULT_WAIT_TIMEOUT=1000
ELEMENT_VISIBLE_TIMEOUT=2000
NEW_TAB_DETECT_TIMEOUT=600

# 减少截图（仅失败时截图）
ENABLE_STEP_SCREENSHOTS=false
```

**预期效果：**
- ⏱️ 执行时间减少 **30-40%**
- 平均测试时间：**35-70秒**

---

### 方案二：使用更快的AI模型

**切换到 Claude 3.5 Haiku（更快但精度略低）：**
```bash
AI_MODEL_NAME=claude-3-5-haiku-20241022
AI_MAX_TOKENS=1500
```

**对比：**
| 模型 | 速度 | 精度 | 成本 |
|-----|------|------|------|
| Sonnet | 15-30 tps | ⭐⭐⭐⭐⭐ | $$$ |
| Haiku | 40-80 tps | ⭐⭐⭐⭐ | $ |

**预期效果：**
- ⏱️ AI处理时间减少 **50-60%**
- 平均测试时间：**20-50秒**

---

### 方案三：并发执行（适合测试套件）

**启用并发执行（谨慎使用）：**
```bash
MAX_CONCURRENCY=3  # 最多3个测试同时运行
```

**⚠️ 注意事项：**
- 增加系统资源消耗
- 可能影响测试稳定性
- 适合独立的测试用例

**预期效果：**
- ⏱️ 套件执行时间减少 **50-70%**（如果测试独立）

---

## 🎯 性能模式对比

系统提供三种预设模式，可通过 `PERFORMANCE_MODE` 环境变量切换：

### 1. 快速模式 (fast)
```bash
PERFORMANCE_MODE=fast
```

**特点：**
- ✅ 最快执行速度
- ⚠️ 可能降低稳定性
- 💡 适合开发环境快速验证

**配置：**
- 禁用图片加载
- 最短等待时间（1-2秒）
- 最大并发5个
- 使用Haiku模型

**预期时间：** 20-50秒/测试

---

### 2. 平衡模式 (balanced) **[默认]**
```bash
PERFORMANCE_MODE=balanced
```

**特点：**
- ✅ 速度与稳定性平衡
- ✅ 适合大多数场景
- 💡 推荐生产环境

**配置：**
- 加载所有资源
- 适中等待时间（2-3秒）
- 最大并发3个
- 使用Sonnet模型

**预期时间：** 55-113秒/测试（当前）

---

### 3. 稳定模式 (stable)
```bash
PERFORMANCE_MODE=stable
```

**特点：**
- ✅ 最高稳定性和准确性
- ⚠️ 执行速度较慢
- 💡 适合关键业务流程测试

**配置：**
- 加载所有资源
- 最长等待时间（3-5秒）
- 单线程执行
- 使用Sonnet模型
- 启用视频录制

**预期时间：** 80-150秒/测试

---

## 📈 实际优化步骤

### Step 1: 复制性能配置
```bash
# 复制性能配置模板
cp .env.performance .env.local

# 编辑 .env.local，选择合适的配置
# 然后将配置复制到 .env
```

### Step 2: 重启服务
```bash
# 停止当前服务
Ctrl + C

# 重新启动
npm run dev
```

### Step 3: 运行测试并观察性能
```bash
# 在测试运行时，查看控制台输出
# 会显示每个步骤的耗时
```

### Step 4: 根据结果调整
- 如果测试失败率上升 → 调回 `balanced` 或 `stable`
- 如果速度仍然慢 → 尝试 `fast` + Haiku模型
- 如果需要最高稳定性 → 使用 `stable`

---

## 🛠️ 高级优化

### 1. 自定义超时时间
如果某些步骤总是超时，可以单独调整：

```bash
# 全局超时（影响所有操作）
PLAYWRIGHT_TIMEOUT=10000  # 10秒

# 页面导航超时
PLAYWRIGHT_NAV_TIMEOUT=15000  # 15秒

# 元素查找超时
ELEMENT_VISIBLE_TIMEOUT=3000  # 3秒
```

### 2. 针对特定测试优化
在测试步骤中可以指定等待时间：

```
步骤1: 打开网页 | 页面加载完成
步骤2: 等待3秒 | 确保元素加载
步骤3: 点击按钮 | 页面跳转
```

### 3. 网络条件优化
```bash
# 如果网络慢，增加导航超时
PLAYWRIGHT_NAV_TIMEOUT=30000  # 30秒
```

---

## 📊 性能监控

系统内置性能监控，会自动记录：

- ✅ 总运行次数
- ✅ 成功率
- ⏱️ 平均执行时间
- 🚀 优化模式使用次数

**查看性能报告：**
性能统计会在控制台定期输出，格式如下：

```
性能监控报告:
📊 总运行次数: 50
✅ 成功率: 94.0%
⏱️  平均用时: 45.3秒
🚀 优化模式运行: 35次
🛡️ 安全模式运行: 15次
```

---

## 🎓 最佳实践建议

### 开发阶段
```bash
PERFORMANCE_MODE=fast
PLAYWRIGHT_DISABLE_IMAGES=true
ENABLE_STEP_SCREENSHOTS=false
AI_MODEL_NAME=claude-3-5-haiku-20241022
```
**目标：** 快速迭代，验证功能

### 测试阶段
```bash
PERFORMANCE_MODE=balanced
ENABLE_STEP_SCREENSHOTS=true
AI_MODEL_NAME=claude-3-5-sonnet-20241022
```
**目标：** 平衡速度和准确性

### 生产阶段
```bash
PERFORMANCE_MODE=stable
ENABLE_STEP_SCREENSHOTS=true
ENABLE_VIDEO_RECORDING=true
AI_MODEL_NAME=claude-3-5-sonnet-20241022
```
**目标：** 最高稳定性，完整证据

---

## ❓ 常见问题

### Q: 为什么禁用图片还是很慢？
A: 测试执行慢的主要原因是AI模型处理速度，图片加载只占10-20%时间。建议同时：
- 切换到Haiku模型
- 减少等待时间
- 简化测试步骤

### Q: 并发执行会影响结果吗？
A: 如果测试之间互不影响（如测试不同页面），可以安全并发。如果测试共享状态（如登录状态），不建议并发。

### Q: 如何知道当前是哪种模式？
A: 启动服务时会在控制台输出：
```
📊 当前性能配置:
   模式: balanced
   ...
```

### Q: 可以运行时切换模式吗？
A: 目前需要重启服务。未来版本会支持热切换。

---

## 📞 技术支持

如果优化后仍然遇到性能问题，请提供：

1. 性能监控报告（控制台输出）
2. 测试用例步骤数量
3. 当前 `.env` 配置
4. 系统资源使用情况（CPU、内存）

我们会帮您进一步诊断和优化！
