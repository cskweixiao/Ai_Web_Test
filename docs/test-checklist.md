# 智能补全功能测试清单

## 前置条件
- [ ] 后端服务运行正常 (端口 3001)
- [ ] 前端服务运行正常 (端口 5173)
- [ ] 数据库已更新 schema (npx prisma db push)
- [ ] 已配置 OpenRouter API Key

## 测试环境准备
```bash
# 1. 确保数据库 schema 最新
cd d:\AI_mvp\ai_test\project
npx prisma db push

# 2. 启动后端
npm run dev:server

# 3. 启动前端 (新终端)
npm run dev:frontend

# 4. 浏览器访问
http://localhost:5173/functional-test-cases/generator
```

## 功能测试用例

### ✅ 测试用例 1: 正常流程 - 有不确定信息

**步骤:**
1. 访问功能测试用例生成器页面
2. 上传 Axure HTML + JS 文件 (至少2个文件)
3. 填写必填信息:
   - 页面名称: "订单列表页"
   - 系统名称: "电商后台管理系统"
   - 模块名称: "订单管理"
4. 点击"开始解析"

**预期结果 A - 解析阶段:**
- [ ] 显示"正在解析原型文件..."加载状态
- [ ] 解析成功后显示绿色成功提示框
- [ ] 自动跳转到步骤2
- [ ] 显示"AI 正在预分析原型..."加载状态
- [ ] 预分析完成时间 < 15秒

**预期结果 B - 智能补全对话框:**
- [ ] 自动弹出智能补全对话框
- [ ] 显示 AI 置信度（如：75%）
- [ ] 显示不确定信息数量（如：2 个关键信息）
- [ ] 显示进度条（初始进度应该等于 certainFields / totalFields）
- [ ] "AI已确定的信息"区域可折叠展开
- [ ] 高优先级问题显示红色"必答"标签
- [ ] 中优先级问题显示橙色"建议"标签
- [ ] 低优先级问题区域默认折叠

**预期结果 C - 问题卡片:**
- [ ] 每个问题显示问题文字
- [ ] 显示上下文信息（页面名称、字段名）
- [ ] AI推测值以 Tag 形式展示
- [ ] 有"✓ 接受AI推测"和"⏭ 跳过"两个按钮
- [ ] 点击"接受AI推测"后卡片变灰，显示"✅ 已确认"
- [ ] 点击"跳过"后卡片变灰，显示"✅ 已跳过"
- [ ] 进度条实时更新

**预期结果 D - 提交确认:**
- [ ] 有高优先级问题未回答时，"确认并生成需求文档"按钮禁用
- [ ] 所有高优先级问题回答后，按钮启用
- [ ] 点击"确认并生成需求文档"后:
  - [ ] 对话框关闭
  - [ ] 显示"AI 正在生成需求文档..."加载状态
  - [ ] 生成成功后显示需求文档编辑器
  - [ ] 需求文档包含用户确认的信息（检查关键字）
  - [ ] 显示成功提示："增强需求文档生成成功！"

---

### ✅ 测试用例 2: 跳过智能补全

**步骤:**
1. 完成测试用例1的步骤1-4，等待智能补全对话框打开
2. 点击"跳过补全，直接生成"按钮

**预期结果:**
- [ ] 对话框立即关闭
- [ ] 显示提示："已跳过智能补全，使用原始数据生成需求文档"
- [ ] 显示"AI 正在生成需求文档..."加载状态
- [ ] 生成成功后显示需求文档编辑器
- [ ] 需求文档使用原始方式生成（不包含用户确认的增强信息）

---

### ✅ 测试用例 3: 正常流程 - 无不确定信息

**步骤:**
1. 上传一个字段定义非常完整的 Axure 文件
2. 完成必填信息填写
3. 点击"开始解析"

**预期结果:**
- [ ] 解析成功
- [ ] 显示"AI 正在预分析原型..."
- [ ] AI预分析结果返回 uncertainInfo = [] (空数组)
- [ ] 智能补全对话框**不打开**
- [ ] 显示提示："原型信息完整，直接生成需求文档"
- [ ] 直接进入需求文档生成阶段
- [ ] 生成成功后显示需求文档

---

### ✅ 测试用例 4: 容错 - AI预分析失败

**步骤:**
1. 断开网络或临时修改 API Key 为错误值
2. 上传 Axure 文件并点击"开始解析"

**预期结果:**
- [ ] 解析成功
- [ ] 显示"AI 正在预分析原型..."
- [ ] AI预分析失败（网络错误或API错误）
- [ ] 智能补全对话框**不打开**
- [ ] 显示警告提示："AI预分析失败，将使用原始方式生成需求文档"
- [ ] 自动回退到原始流程
- [ ] 使用原始 API 生成需求文档
- [ ] 生成成功后显示需求文档

---

### ✅ 测试用例 5: 进度条和统计准确性

**步骤:**
1. 完成测试用例1的步骤1-4，等待智能补全对话框打开
2. 记录初始状态:
   - AI置信度
   - 总字段数、确定字段数、不确定字段数
   - 进度百分比
3. 逐个回答问题，观察进度更新

**预期结果:**
- [ ] 初始进度 = (certainFields / totalFields) * 100
- [ ] 每回答一个问题，进度增加
- [ ] 最终进度 = ((certainFields + answeredQuestions) / totalFields) * 100
- [ ] 确认进度显示："X / Y" 格式正确
- [ ] 进度条颜色渐变（紫色到粉色）

---

### ✅ 测试用例 6: 数据持久化

**步骤:**
1. 完成完整的智能补全流程
2. 打开数据库，查询 `ai_generation_sessions` 表
3. 找到对应的 sessionId 记录

**预期结果:**
- [ ] `pre_analysis_result` 字段包含完整的 PreAnalysisResult JSON
- [ ] `enhanced_data` 字段包含完整的 EnhancedAxureData JSON
- [ ] `requirement_doc` 字段包含生成的需求文档
- [ ] JSON 数据结构正确，可以被解析

**SQL 查询:**
```sql
SELECT
  id,
  JSON_EXTRACT(pre_analysis_result, '$.confidence') as confidence,
  JSON_EXTRACT(pre_analysis_result, '$.uncertainInfo') as uncertainInfo,
  JSON_EXTRACT(enhanced_data, '$.enrichedInfo') as enrichedInfo,
  CHAR_LENGTH(requirement_doc) as doc_length
FROM ai_generation_sessions
WHERE id = '<sessionId>'
LIMIT 1;
```

---

### ✅ 测试用例 7: 多种不确定信息类型

**准备数据:**
上传包含以下元素的 Axure 文件:
- 下拉框（无明确选项）
- 按钮（触发不明确业务规则）
- 简写字段（如：sn, no, code）
- 输入框（无校验规则说明）

**步骤:**
1. 上传文件并解析
2. 等待智能补全对话框打开
3. 检查识别的不确定信息类型

**预期结果:**
- [ ] AI 识别出 enumValues 类型问题（下拉框可选值）
- [ ] AI 识别出 businessRule 类型问题（业务规则）
- [ ] AI 识别出 fieldMeaning 类型问题（字段含义）
- [ ] AI 识别出 validationRule 类型问题（校验规则）
- [ ] 每种类型的 aiGuess 合理（不是空数组或乱猜）

---

### ✅ 测试用例 8: 用户确认数据正确传递到需求文档

**步骤:**
1. 完成智能补全流程，确认所有问题
2. 等待需求文档生成
3. 在需求文档编辑器中搜索关键字

**预期结果 - 检查需求文档内容:**

如果确认了枚举值 `["待支付", "已支付", "已发货"]`:
- [ ] 需求文档包含这些确切的枚举值
- [ ] 格式为列表或表格

如果确认了业务规则 `"只能删除待支付订单"`:
- [ ] 需求文档包含这条规则的描述
- [ ] 出现在相关功能的业务规则或约束条件章节

如果确认了字段含义 `"sn = 订单编号"`:
- [ ] 需求文档将 sn 解释为订单编号
- [ ] 出现在字段说明或数据字典章节

---

### ✅ 测试用例 9: 性能测试

**步骤:**
1. 准备不同规模的 Axure 文件:
   - 小型: 1个页面，10个元素
   - 中型: 3个页面，50个元素
   - 大型: 5个页面，100个元素
2. 分别测试，记录时间

**预期结果:**

| 阶段             | 小型      | 中型      | 大型      | 目标   |
|------------------|-----------|-----------|-----------|--------|
| 解析Axure        | < 10秒    | < 20秒    | < 30秒    | 通过   |
| AI预分析         | < 5秒     | < 8秒     | < 12秒    | <15秒  |
| 生成需求文档     | < 40秒    | < 60秒    | < 90秒    | <120秒 |

---

### ✅ 测试用例 10: UI响应式和交互细节

**步骤:**
1. 打开智能补全对话框
2. 测试各种交互

**预期结果:**
- [ ] 对话框宽度 900px，居中显示
- [ ] 对话框内容可滚动
- [ ] Collapse 组件展开/收起动画流畅
- [ ] 按钮 hover 状态正常
- [ ] Loading 状态显示正确（按钮禁用 + loading图标）
- [ ] 进度条动画流畅
- [ ] Tag 颜色区分清晰（蓝色 AI推测 / 绿色 已确认）
- [ ] 卡片背景色根据优先级正确显示（红色/橙色/灰色边框）

---

## 调试技巧

### 查看前端日志
打开浏览器开发者工具 (F12) → Console

关键日志:
```
🔍 开始AI预分析...
📋 识别到 X 个不确定信息
✅ 用户确认完成，开始生成增强需求文档
📊 确认数量: X
```

### 查看后端日志
后端终端会显示:

```
🔍 [AI预分析] 开始分析会话 abc-123...
   📊 输入数据: 1页, 15元素
   🚀 [AI预分析] 调用大模型API...
   ✅ [AI预分析] 完成 (耗时: 8234ms)
   📊 [AI预分析] 结果统计:
      - 置信度: 75.0%
      - 确定信息: 18条
      - 不确定信息: 7条
         * 高优先级: 3条
         * 中优先级: 3条
         * 低优先级: 1条
      - 缺失关键信息: 2条
```

### 查看网络请求
开发者工具 → Network → XHR

关键请求:
1. `POST /api/v1/axure/parse-multi` - 解析Axure
2. `POST /api/v1/axure/pre-analyze` - AI预分析
3. `POST /api/v1/axure/generate-requirement-enhanced` - 生成增强需求文档

检查 Response:
```json
{
  "success": true,
  "data": {
    "confidence": 0.75,
    "uncertainInfo": [...]
  }
}
```

### 常见问题排查

**问题1: 智能补全对话框不弹出**
- 检查: console.log 是否有 "识别到 X 个不确定信息"
- 检查: uncertainInfo 数组是否为空
- 检查: completionModalOpen 状态是否为 true

**问题2: 点击确认按钮无反应**
- 检查: 是否有高优先级问题未回答
- 检查: hasUnansweredHighPriority 变量值
- 检查: 按钮 disabled 属性

**问题3: 需求文档不包含用户确认信息**
- 检查: generateRequirementEnhanced 是否被调用（不是 generateRequirement）
- 检查: enhancedData 结构是否正确
- 检查: buildEnhancedContext 返回的上下文字符串
- 检查: 后端日志中是否有增强上下文

**问题4: API 调用失败**
- 检查: OpenRouter API Key 是否配置正确
- 检查: 代理设置（如有）
- 检查: 网络连接
- 检查: 后端错误日志

---

## 回归测试

确保原有功能未被破坏:

- [ ] 不使用智能补全的原始流程仍然正常工作
- [ ] 直接点击"跳过补全"可以正常生成需求文档
- [ ] 批量生成测试用例流程正常
- [ ] 保存测试用例到数据库正常
- [ ] 其他页面功能不受影响

---

## 测试完成标准

- [ ] 所有测试用例通过
- [ ] 无 Console 错误
- [ ] 无 TypeScript 编译错误
- [ ] 用户体验流畅，无卡顿
- [ ] 需求文档准确率达到 85%+（主观评估）
- [ ] 性能满足目标要求

---

**测试日期**: ___________
**测试人员**: ___________
**测试结果**: ___________
