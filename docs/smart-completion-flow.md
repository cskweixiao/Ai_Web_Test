# 智能补全功能流程图

## 完整流程对比

```
┌─────────────────────────────────────────────────────────────────┐
│                      原始流程 (60% 准确率)                        │
└─────────────────────────────────────────────────────────────────┘

  ┌──────────┐      ┌──────────────┐      ┌──────────────┐
  │上传Axure │ ───> │生成需求文档   │ ───> │生成测试用例   │
  │          │      │ (60-90秒)    │      │              │
  └──────────┘      └──────────────┘      └──────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                    改进流程 (85%+ 准确率)                         │
└─────────────────────────────────────────────────────────────────┘

  ┌──────────┐      ┌──────────┐      ┌──────────────┐
  │上传Axure │ ───> │AI预分析  │ ───> │智能补全对话框 │
  │          │      │ (10秒)   │      │ (3-5分钟)    │
  └──────────┘      └──────────┘      └──────────────┘
                                              │
                                              ▼
  ┌──────────┐      ┌─────────────────┐
  │生成测试用例│ <─── │生成增强需求文档 │
  │          │      │  (60-90秒)      │
  └──────────┘      └─────────────────┘
```

## 详细交互流程

```
用户操作                    系统状态                         后端API
────────                    ────────                         ───────

1️⃣ 上传文件 + 填写信息
   │
   ▼
2️⃣ 点击"开始解析"
   │                      parsing = true
   ▼                           │
                              ▼
                         解析Axure文件 ────────────> POST /axure/parse-multi
                              │                              │
                              │ <──────────────────────────── sessionId, axureData
                              ▼
                         currentStep = 1
                         preAnalyzing = true
                              │
                              ▼
                         执行AI预分析 ──────────────> POST /axure/pre-analyze
                              │                              │
                              │ <──────────────────────────── PreAnalysisResult
                              ▼                                    │
                         判断是否有不确定信息 <───────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                有 uncertainInfo      无 uncertainInfo
                    ▼                   ▼
          completionModalOpen = true   直接生成需求文档
                    │
3️⃣ 智能补全对话框打开
   │
   ├─ 显示AI已确定的信息 (可折叠)
   ├─ 高优先级问题 (必答)
   ├─ 中优先级问题 (建议)
   └─ 低优先级问题 (可折叠)
   │
   ▼
4️⃣ 用户确认每个问题
   │
   ├─ 点击"接受AI推测" ────> confirmed = true, userValue = aiGuess
   │
   └─ 点击"跳过" ────────────> skipped = true
   │
   ▼
5️⃣ 点击"确认并生成需求文档"
   │                      completionModalOpen = false
   ▼                      generating = true
                              │
                              ▼
                         构建enhancedData
                              │
                              ▼
                         生成增强需求文档 ──────────> POST /axure/generate-requirement-enhanced
                              │                              │
                              │                              ├─ buildEnhancedContext()
                              │                              ├─ 调用大模型API
                              │ <──────────────────────────── requirementDoc
                              ▼
                         显示需求文档编辑器
                         generating = false
   │
   ▼
6️⃣ 编辑需求文档 (可选)
   │
   ▼
7️⃣ 点击"生成测试用例"
   │
   ▼
   ... (后续流程不变)


═══════════════════════════════════════════════════════════════════
                         容错分支
═══════════════════════════════════════════════════════════════════

如果AI预分析失败:
   │
   ▼
返回空的 uncertainInfo ────> 直接调用原始 generateRequirementDoc()
   │
   ▼
正常生成需求文档 (降级到原始流程)


如果用户点击"跳过补全":
   │
   ▼
completionModalOpen = false ───> 调用原始 generateRequirementDoc()
   │
   ▼
正常生成需求文档 (降级到原始流程)
```

## 数据流转示例

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI预分析阶段 (10秒)                            │
└─────────────────────────────────────────────────────────────────┘

输入:
{
  sessionId: "abc-123",
  axureData: {
    pageCount: 1,
    elementCount: 15,
    pages: [
      {
        name: "订单列表页",
        elements: [
          { type: "select", name: "订单状态", options: [] },
          { type: "button", text: "删除订单" },
          ...
        ]
      }
    ]
  }
}

       │
       ▼ AI分析 (temperature=0.2, max_tokens=3000)
       │

输出:
{
  sessionId: "abc-123",
  confidence: 0.75,
  clearInfo: [
    "订单列表页包含5个查询条件",
    "列表操作列包含：查看、编辑、删除按钮"
  ],
  uncertainInfo: [
    {
      id: "unc-1",
      type: "enumValues",
      field: "订单状态",
      question: "订单状态的完整可选值有哪些？",
      aiGuess: ["待支付", "已支付", "已发货", "已完成"],
      importance: "high",
      context: { pageName: "订单列表页", elementType: "select" }
    },
    {
      id: "unc-2",
      type: "businessRule",
      trigger: "点击删除订单按钮",
      question: "删除订单的业务规则是什么？",
      aiGuess: ["只能删除待支付订单", "需要弹窗二次确认"],
      importance: "high",
      context: { pageName: "订单列表页" }
    }
  ],
  missingCritical: ["订单金额的计算规则"],
  statistics: {
    totalFields: 25,
    certainFields: 18,
    uncertainFields: 7
  }
}


┌─────────────────────────────────────────────────────────────────┐
│                  用户确认阶段 (3-5分钟)                           │
└─────────────────────────────────────────────────────────────────┘

用户操作:
- unc-1: 点击"接受AI推测"
- unc-2: 点击"接受AI推测"

       │
       ▼

confirmations = [
  {
    id: "unc-1",
    confirmed: true,
    userValue: ["待支付", "已支付", "已发货", "已完成"],
    skipped: false
  },
  {
    id: "unc-2",
    confirmed: true,
    userValue: ["只能删除待支付订单", "需要弹窗二次确认"],
    skipped: false
  }
]

       │
       ▼ buildEnhancedData()
       │

enhancedData = {
  originalData: { /* axureData */ },
  preAnalysis: { /* PreAnalysisResult */ },
  userConfirmations: [ /* confirmations */ ],
  enrichedInfo: {
    confirmedEnums: {
      "订单状态": ["待支付", "已支付", "已发货", "已完成"]
    },
    confirmedRules: [
      {
        field: "删除订单",
        rule: "只能删除待支付订单; 需要弹窗二次确认"
      }
    ],
    confirmedMeanings: {},
    confirmedValidations: []
  }
}


┌─────────────────────────────────────────────────────────────────┐
│              生成增强需求文档阶段 (60-90秒)                        │
└─────────────────────────────────────────────────────────────────┘

AI Prompt构建:

系统提示词:
"你是需求分析专家..."

+

用户确认的增强上下文:
"""
## 🎯 用户已确认的关键信息（必须遵守！）

### 1️⃣ 枚举值
- 订单状态: ["待支付", "已支付", "已发货", "已完成"]

### 2️⃣ 业务规则
- 删除订单: 只能删除待支付订单; 需要弹窗二次确认

📌 **重要**: 以上信息是用户明确确认的，优先级最高！
"""

+

原始Axure数据:
"## 原型数据
页面名称: 订单列表页
..."

       │
       ▼ AI生成 (temperature=0.3, max_tokens=8000)
       │

输出: requirementDoc (Markdown格式)
"""
# 订单列表页需求文档

## 1. 页面概述
...

## 2. 查询条件
- **订单状态**（下拉框）
  - 可选值: 待支付、已支付、已发货、已完成
  - 说明: 用户确认的完整状态列表
...

## 3. 操作功能
### 3.1 删除订单
- 触发条件: 点击"删除"按钮
- 业务规则:
  1. 只能删除"待支付"状态的订单
  2. 删除前弹窗二次确认
  3. 确认后删除，成功后刷新列表
...
"""
```

## UI交互细节

```
┌──────────────────────────────────────────────────────────────┐
│                     智能补全对话框                            │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ✨ 智能补全 - AI已识别 75% 的信息                            │
│     以下 2 个关键信息需要您确认，预计 3-5 分钟完成            │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 确认进度: 0 / 2                          75% 完成      │  │
│  │ ████████████████████████░░░░░░░░                      │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
│  ✅ AI已确定的信息（2条）                     [展开/收起]      │
│                                                               │
│  ─────────────────────────────────────────────────────────  │
│                                                               │
│  🚨 高优先级问题（必答）                                       │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 1️⃣  订单状态的完整可选值有哪些？           [必答]       │  │
│  │     📍 订单列表页 · 字段: 订单状态                      │  │
│  │                                                         │  │
│  │     AI推测:                                             │  │
│  │     [待支付]  [已支付]  [已发货]  [已完成]              │  │
│  │                                                         │  │
│  │     [✓ 接受AI推测]  [⏭ 跳过]                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 2️⃣  删除订单的业务规则是什么？             [必答]       │  │
│  │     📍 订单列表页                                       │  │
│  │                                                         │  │
│  │     AI推测:                                             │  │
│  │     [只能删除待支付订单]  [需要弹窗二次确认]            │  │
│  │                                                         │  │
│  │     [✓ 接受AI推测]  [⏭ 跳过]                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
│  ─────────────────────────────────────────────────────────  │
│                                                               │
│  [跳过补全，直接生成]          [确认并生成需求文档] (禁用)    │
│                                                               │
└──────────────────────────────────────────────────────────────┘


用户点击"接受AI推测"后:

┌──────────────────────────────────────────────────────────────┐
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 1️⃣  订单状态的完整可选值有哪些？           [必答]       │  │
│  │     📍 订单列表页 · 字段: 订单状态                      │  │
│  │                                                         │  │
│  │     AI推测:                                             │  │
│  │     [待支付]  [已支付]  [已发货]  [已完成]              │  │
│  │                                                         │  │
│  │     ✅ 已确认                                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
│  进度更新: 1 / 2                              87% 完成        │
│  ████████████████████████████░░░░░                          │
└──────────────────────────────────────────────────────────────┘


所有高优先级问题回答后:

┌──────────────────────────────────────────────────────────────┐
│  [跳过补全，直接生成]          [确认并生成需求文档] (启用) ✨  │
└──────────────────────────────────────────────────────────────┘
```

## 性能指标

```
阶段                  目标时间      实际API调用
───────────────────  ─────────    ─────────────────
1. 解析Axure         10-30秒      parseAxureMulti
2. AI预分析          <10秒        preAnalyze
3. 用户确认          3-5分钟      (前端交互)
4. 生成增强需求文档   60-90秒      generateRequirementEnhanced
───────────────────────────────────────────────────
总计                 4-7分钟      3次API调用


对比原始流程:
阶段                  目标时间      实际API调用
───────────────────  ─────────    ─────────────────
1. 解析Axure         10-30秒      parseAxureMulti
2. 生成需求文档      60-90秒      generateRequirement
───────────────────────────────────────────────────
总计                 1.5-2分钟    2次API调用


结论:
- 时间增加: 2.5-5分钟
- 准确率提升: 60% → 85%+
- 投入回报比: 非常高（节省后期大量修改时间）
```

---

**更新日期**: 2025年11月5日
