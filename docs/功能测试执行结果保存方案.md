# åŠŸèƒ½æµ‹è¯•æ‰§è¡Œç»“æœä¿å­˜æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆå®ç°äº†åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œç»“æœçš„å®Œæ•´ä¿å­˜æœºåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®å­˜å‚¨ã€æ‰§è¡Œæ—¥å¿—å…³è”ã€å†å²è®°å½•æŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ ¸å¿ƒè¡¨ç»“æ„

#### `functional_test_executions` è¡¨

```sql
model functional_test_executions {
  id                    String                        @id @default(uuid()) @db.VarChar(100)
  test_case_id          Int                          // å…³è”åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ID
  test_case_name        String                        @db.VarChar(255)
  
  // æ‰§è¡Œç»“æœ
  final_result          functional_execution_result  // pass | fail | block
  actual_result         String                        @db.Text
  comments              String?                       @db.Text
  
  // æ‰§è¡Œä¿¡æ¯
  duration_ms           Int?                          // æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  executed_at           DateTime                      @default(now()) @db.Timestamp(0)
  executor_id           Int                           // æ‰§è¡ŒäººID
  executor_department   String?                       @db.VarChar(100)
  
  // æ­¥éª¤æ‰§è¡Œè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
  step_results          Json?                         // [{action, expected, result, note}]
  total_steps           Int                           @default(0)
  completed_steps       Int                           @default(0)
  passed_steps          Int                           @default(0)
  failed_steps          Int                           @default(0)
  blocked_steps         Int                           @default(0)
  
  // é™„ä»¶å’Œæˆªå›¾ï¼ˆJSONæ ¼å¼ï¼‰
  screenshots           Json?                         // [{ url, filename, timestamp }]
  attachments           Json?                         // [{ url, filename, size, type }]
  
  // å…ƒæ•°æ®
  metadata              Json?                         // å…¶ä»–å…ƒæ•°æ®
  
  // å…³è”å…³ç³»
  test_case             functional_test_cases         @relation(fields: [test_case_id], references: [id], onDelete: Cascade)
  executor              users                         @relation(fields: [executor_id], references: [id], onDelete: Cascade)
  
  // ç´¢å¼•
  @@index([test_case_id])
  @@index([executor_id])
  @@index([executed_at])
  @@index([final_result])
  @@index([executor_department])
}
```

### 2. å…³è”å…³ç³»

```
functional_test_cases (åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹)
    â†“ (1:N)
functional_test_executions (æ‰‹å·¥æ‰§è¡Œè®°å½•)

users (ç”¨æˆ·è¡¨)
    â†“ (1:N)
functional_test_executions (æ‰‹å·¥æ‰§è¡Œè®°å½•)

test_cases (è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹)
    â†“ (1:N)  
test_case_executions (è‡ªåŠ¨åŒ–æ‰§è¡Œè®°å½•)
```

### 3. æ‰§è¡Œæ—¥å¿—å…³è”æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šé€šè¿‡ test_case_id å…³è”ï¼ˆæ¨èï¼‰

```sql
-- æŸ¥è¯¢æŸä¸ªåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹çš„æ‰€æœ‰æ‰§è¡Œè®°å½•ï¼ˆæ‰‹å·¥+è‡ªåŠ¨åŒ–ï¼‰
SELECT 
  'manual' as execution_type,
  fte.id as execution_id,
  fte.test_case_name,
  fte.final_result,
  fte.executed_at,
  fte.duration_ms,
  u.username as executor
FROM functional_test_executions fte
JOIN users u ON fte.executor_id = u.id
WHERE fte.test_case_id = ?

UNION ALL

SELECT 
  'automated' as execution_type,
  tce.id as execution_id,
  tc.title as test_case_name,
  tce.status as final_result,
  tce.started_at as executed_at,
  tce.duration_ms,
  u.username as executor
FROM test_case_executions tce
JOIN test_cases tc ON tce.test_case_id = tc.id
LEFT JOIN users u ON tce.executor_user_id = u.id
WHERE tc.id = ?

ORDER BY executed_at DESC;
```

#### æ–¹æ¡ˆBï¼šé€šè¿‡ç”¨ä¾‹åç§°å…³è”ï¼ˆè¾…åŠ©ï¼‰

```sql
-- é€šè¿‡ç”¨ä¾‹åç§°æ¨¡ç³ŠåŒ¹é…æ‰§è¡Œè®°å½•
SELECT * FROM functional_test_executions 
WHERE test_case_name LIKE '%ç”¨ä¾‹åç§°%';
```

#### æ–¹æ¡ˆCï¼šé€šè¿‡å…ƒæ•°æ®å…³è”ï¼ˆæ‰©å±•ï¼‰

åœ¨ `metadata` å­—æ®µä¸­å¯ä»¥å­˜å‚¨é¢å¤–çš„å…³è”ä¿¡æ¯ï¼š

```json
{
  "system": "ç³»ç»Ÿåç§°",
  "module": "æ¨¡å—åç§°",
  "scenario_name": "æµ‹è¯•åœºæ™¯",
  "test_point_name": "æµ‹è¯•ç‚¹åç§°",
  "automated_execution_id": "è‡ªåŠ¨åŒ–æ‰§è¡Œè®°å½•ID",
  "related_bug_ids": ["BUG-001", "BUG-002"]
}
```

## ğŸ”§ åç«¯å®ç°

### 1. æœåŠ¡å±‚ (FunctionalTestCaseService)

#### ä¿å­˜æ‰§è¡Œç»“æœ

```typescript
async saveExecutionResult(data: {
  testCaseId: number;
  testCaseName: string;
  finalResult: 'pass' | 'fail' | 'block';
  actualResult: string;
  comments?: string;
  durationMs: number;
  executorId: number;
  executorDepartment?: string;
  stepResults?: any[];
  totalSteps?: number;
  completedSteps?: number;
  passedSteps?: number;
  failedSteps?: number;
  blockedSteps?: number;
  screenshots?: any[];
  attachments?: any[];
  metadata?: any;
})
```

#### è·å–æ‰§è¡Œå†å²

```typescript
async getExecutionHistory(testCaseId: number, limit = 10)
```

#### è·å–æ‰§è¡Œè¯¦æƒ…

```typescript
async getExecutionById(executionId: string)
```

### 2. API è·¯ç”±

#### POST `/api/v1/functional-test-cases/:id/execute`

æäº¤æµ‹è¯•æ‰§è¡Œç»“æœ

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
  "testCaseName": "ç™»å½•åŠŸèƒ½æµ‹è¯•",
  "finalResult": "pass",
  "actualResult": "æ‰€æœ‰æ­¥éª¤æ‰§è¡Œé€šè¿‡ï¼ŒåŠŸèƒ½æ­£å¸¸",
  "comments": "æµ‹è¯•ç¯å¢ƒï¼šChrome 120",
  "durationMs": 180000,
  "stepResults": [
    {
      "stepIndex": 1,
      "action": "æ‰“å¼€ç™»å½•é¡µé¢",
      "expected": "é¡µé¢æ­£å¸¸æ˜¾ç¤º",
      "result": "pass",
      "note": ""
    }
  ],
  "totalSteps": 4,
  "completedSteps": 4,
  "passedSteps": 4,
  "failedSteps": 0,
  "blockedSteps": 0,
  "metadata": {
    "system": "ç”¨æˆ·ä¸­å¿ƒ",
    "browser": "Chrome 120"
  }
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "data": {
    "executionId": "550e8400-e29b-41d4-a716-446655440000",
    "testCaseId": 123,
    "executedAt": "2024-12-04T10:30:00Z"
  },
  "message": "æµ‹è¯•ç»“æœå·²ä¿å­˜"
}
```

#### GET `/api/v1/functional-test-cases/:id/executions`

è·å–æµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œå†å²

**æŸ¥è¯¢å‚æ•°ï¼š**
- `limit`: è¿”å›è®°å½•æ•°ï¼Œé»˜è®¤ 10

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "data": [
    {
      "executionId": "uuid",
      "testCaseId": 123,
      "testCaseName": "ç™»å½•åŠŸèƒ½æµ‹è¯•",
      "finalResult": "pass",
      "actualResult": "æµ‹è¯•é€šè¿‡",
      "durationMs": 180000,
      "executedAt": "2024-12-04T10:30:00Z",
      "executor": {
        "id": 1,
        "username": "å¼ ä¸‰",
        "department": "æµ‹è¯•éƒ¨"
      },
      "totalSteps": 4,
      "completedSteps": 4,
      "passedSteps": 4
    }
  ]
}
```

#### GET `/api/v1/functional-test-cases/executions/:executionId`

è·å–å•ä¸ªæ‰§è¡Œè®°å½•è¯¦æƒ…

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "data": {
    "executionId": "uuid",
    "testCase": {
      "id": 123,
      "name": "ç™»å½•åŠŸèƒ½æµ‹è¯•",
      "system": "ç”¨æˆ·ä¸­å¿ƒ",
      "module": "ç™»å½•æ¨¡å—"
    },
    "finalResult": "pass",
    "actualResult": "æ‰€æœ‰æ­¥éª¤æ‰§è¡Œé€šè¿‡",
    "comments": "æµ‹è¯•ç¯å¢ƒï¼šChrome 120",
    "durationMs": 180000,
    "executedAt": "2024-12-04T10:30:00Z",
    "executor": {
      "username": "å¼ ä¸‰",
      "department": "æµ‹è¯•éƒ¨"
    },
    "stepResults": [...],
    "screenshots": [...],
    "metadata": {...}
  }
}
```

## ğŸ’» å‰ç«¯å®ç°

### 1. æœåŠ¡å±‚ (functionalTestCaseService)

```typescript
// ä¿å­˜æ‰§è¡Œç»“æœ
async saveExecutionResult(testCaseId: number, data: ExecutionData)

// è·å–æ‰§è¡Œå†å²
async getExecutionHistory(testCaseId: number, limit?: number)

// è·å–æ‰§è¡Œè¯¦æƒ…
async getExecutionById(executionId: string)
```

### 2. é¡µé¢å®ç° (FunctionalTestCaseExecute)

#### æäº¤é€»è¾‘

```typescript
const handleSubmit = async () => {
  // 1. éªŒè¯å¿…å¡«å­—æ®µ
  if (!finalResult || !actualResult.trim()) {
    showToast.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
    return;
  }

  // 2. è®¡ç®—æ­¥éª¤ç»Ÿè®¡
  const passedCount = steps.filter(s => s.result === 'pass').length;
  const failedCount = steps.filter(s => s.result === 'fail').length;
  const blockedCount = steps.filter(s => s.result === 'block').length;

  // 3. è°ƒç”¨APIä¿å­˜ç»“æœ
  const result = await functionalTestCaseService.saveExecutionResult(
    testCaseId,
    {
      testCaseName: testCase?.name || '',
      finalResult,
      actualResult,
      comments,
      durationMs: seconds * 1000,
      stepResults: steps.map((step, index) => ({
        stepIndex: index + 1,
        action: step.action,
        expected: step.expected,
        result: step.result,
        note: step.note
      })),
      totalSteps: steps.length,
      completedSteps,
      passedSteps: passedCount,
      failedSteps: failedCount,
      blockedSteps: blockedCount,
      metadata: {
        system: testCase?.system,
        module: testCase?.module,
        // ... å…¶ä»–å…ƒæ•°æ®
      }
    }
  );

  // 4. å¤„ç†ç»“æœ
  if (result.success) {
    showToast.success('æµ‹è¯•ç»“æœå·²æäº¤ï¼');
    navigate('/functional-test-cases');
  }
};
```

## ğŸ“Š æ•°æ®ç»Ÿè®¡ä¸åˆ†æ

### 1. æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œç»Ÿè®¡

```sql
-- æŸä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œé€šè¿‡ç‡
SELECT 
  test_case_id,
  test_case_name,
  COUNT(*) as total_executions,
  SUM(CASE WHEN final_result = 'pass' THEN 1 ELSE 0 END) as passed,
  SUM(CASE WHEN final_result = 'fail' THEN 1 ELSE 0 END) as failed,
  SUM(CASE WHEN final_result = 'block' THEN 1 ELSE 0 END) as blocked,
  ROUND(SUM(CASE WHEN final_result = 'pass' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM functional_test_executions
WHERE test_case_id = ?
GROUP BY test_case_id, test_case_name;
```

### 2. æ‰§è¡Œäººå‘˜ç»Ÿè®¡

```sql
-- æŒ‰æ‰§è¡Œäººç»Ÿè®¡
SELECT 
  u.username,
  u.department,
  COUNT(*) as total_executions,
  SUM(CASE WHEN fte.final_result = 'pass' THEN 1 ELSE 0 END) as passed,
  AVG(fte.duration_ms / 1000.0 / 60.0) as avg_duration_minutes
FROM functional_test_executions fte
JOIN users u ON fte.executor_id = u.id
WHERE fte.executed_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY u.id, u.username, u.department
ORDER BY total_executions DESC;
```

### 3. æ‰§è¡Œè¶‹åŠ¿åˆ†æ

```sql
-- æ¯æ—¥æ‰§è¡Œç»Ÿè®¡
SELECT 
  DATE(executed_at) as execution_date,
  COUNT(*) as total_executions,
  SUM(CASE WHEN final_result = 'pass' THEN 1 ELSE 0 END) as passed,
  SUM(CASE WHEN final_result = 'fail' THEN 1 ELSE 0 END) as failed,
  SUM(CASE WHEN final_result = 'block' THEN 1 ELSE 0 END) as blocked
FROM functional_test_executions
WHERE executed_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(executed_at)
ORDER BY execution_date;
```

## ğŸ”— æ‰§è¡Œæ—¥å¿—å…³è”æŸ¥è¯¢

### 1. ç»¼åˆæ‰§è¡ŒæŠ¥å‘Š

```sql
-- æŸ¥è¯¢æŸä¸ªåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹çš„å®Œæ•´æ‰§è¡Œå†å²ï¼ˆæ‰‹å·¥+è‡ªåŠ¨åŒ–ï¼‰
WITH manual_executions AS (
  SELECT 
    'manual' as type,
    fte.id,
    fte.test_case_name,
    fte.final_result as result,
    fte.executed_at,
    fte.duration_ms,
    u.username as executor,
    fte.actual_result,
    fte.step_results
  FROM functional_test_executions fte
  JOIN users u ON fte.executor_id = u.id
  WHERE fte.test_case_id = ?
),
automated_executions AS (
  SELECT 
    'automated' as type,
    tce.id,
    tc.title as test_case_name,
    tce.status as result,
    tce.started_at as executed_at,
    tce.duration_ms,
    COALESCE(u.username, 'System') as executor,
    tce.error_message as actual_result,
    tce.execution_logs as step_results
  FROM test_case_executions tce
  JOIN test_cases tc ON tce.test_case_id = tc.id
  LEFT JOIN users u ON tce.executor_user_id = u.id
  WHERE tc.id = ?
)
SELECT * FROM manual_executions
UNION ALL
SELECT * FROM automated_executions
ORDER BY executed_at DESC
LIMIT 50;
```

### 2. æŒ‰ç³»ç»Ÿ/æ¨¡å—ç»Ÿè®¡

```sql
-- é€šè¿‡metadataå…³è”ï¼ŒæŒ‰ç³»ç»Ÿç»Ÿè®¡æ‰§è¡Œæƒ…å†µ
SELECT 
  JSON_EXTRACT(metadata, '$.system') as system,
  JSON_EXTRACT(metadata, '$.module') as module,
  COUNT(*) as total_executions,
  SUM(CASE WHEN final_result = 'pass' THEN 1 ELSE 0 END) as passed,
  ROUND(SUM(CASE WHEN final_result = 'pass' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM functional_test_executions
WHERE metadata IS NOT NULL
  AND executed_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY 
  JSON_EXTRACT(metadata, '$.system'),
  JSON_EXTRACT(metadata, '$.module')
ORDER BY total_executions DESC;
```

## ğŸš€ åç»­æ‰©å±•

### 1. ç¼ºé™·å…³è”

åœ¨ metadata ä¸­å­˜å‚¨å…³è”çš„ç¼ºé™·IDï¼š

```json
{
  "related_bugs": [
    {
      "bug_id": "BUG-001",
      "bug_title": "ç™»å½•å¤±è´¥",
      "bug_status": "open"
    }
  ]
}
```

### 2. æµ‹è¯•ç¯å¢ƒä¿¡æ¯

æ‰©å±• metadata å­˜å‚¨ç¯å¢ƒä¿¡æ¯ï¼š

```json
{
  "environment": {
    "os": "Windows 11",
    "browser": "Chrome 120",
    "screen_resolution": "1920x1080",
    "test_server": "https://test.example.com"
  }
}
```

### 3. æ‰§è¡Œè§†é¢‘/æˆªå›¾

åœ¨ screenshots å’Œ attachments ä¸­å­˜å‚¨è¯æ®æ–‡ä»¶ï¼š

```json
{
  "screenshots": [
    {
      "url": "https://cdn.example.com/screenshots/uuid.png",
      "filename": "step1-login-page.png",
      "timestamp": "2024-12-04T10:30:00Z",
      "step_index": 1
    }
  ],
  "attachments": [
    {
      "url": "https://cdn.example.com/videos/uuid.mp4",
      "filename": "execution-video.mp4",
      "size": 10485760,
      "type": "video/mp4"
    }
  ]
}
```

## ğŸ“ æ€»ç»“

æœ¬æ–¹æ¡ˆå®ç°äº†åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œç»“æœçš„å®Œæ•´ä¿å­˜å’ŒæŸ¥è¯¢åŠŸèƒ½ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šä¿å­˜æ‰§è¡Œç»“æœã€æ­¥éª¤è¯¦æƒ…ã€ç»Ÿè®¡ä¿¡æ¯ç­‰
âœ… **å…³è”åŒ¹é…**ï¼šé€šè¿‡ test_case_id å…³è”åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹å’Œæ‰§è¡Œæ—¥å¿—
âœ… **çµæ´»æ‰©å±•**ï¼šä½¿ç”¨ JSON å­—æ®µå­˜å‚¨å…ƒæ•°æ®ï¼Œä¾¿äºæ‰©å±•
âœ… **å†å²è¿½æº¯**ï¼šå®Œæ•´çš„æ‰§è¡Œå†å²è®°å½•ï¼Œæ”¯æŒåˆ†æå’Œç»Ÿè®¡
âœ… **å¤šç»´åº¦æŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰ç”¨ä¾‹ã€æ‰§è¡Œäººã€æ—¶é—´ã€ç³»ç»Ÿç­‰å¤šç»´åº¦æŸ¥è¯¢

