# Axure 列表字段提取修复

## 问题描述

用户反馈生成的需求文档中**列表展示字段太少，很多都漏了**：

### 原型中的字段（12个）
1. 客户名称 ✓
2. 商品总数量 ✓
3. 申请日期 ✓
4. 申请人 ✓
5. 商品渠道 ✓
6. 结算总金额（集采含税预算成本）（元）❌ **漏掉**
7. 结算总金额（集采含税V链供应价）（元）❌ **漏掉**
8. 销售总金额（元）❌ **漏掉**
9. 当前审批节点 ❌ **漏掉**
10. 当前审批人 ❌ **漏掉**
11. 当前状态 ❌ **漏掉**
12. 订单处理状态 ❌ **漏掉**

### 生成的文档（仅5个）
```markdown
#### 1.1.2 列表展示字段
| 字段名         | 数据类型 | 格式 | 说明             | 来源              |
|----------------|---------|------|------------------|-------------------|
| 客户名称       | 文本     | -    | 显示客户名称     | 集配管理-div      |
| 商品总数量     | 数值     | -    | 显示商品总数量   | 集配管理-div      |
| 申请日期       | 日期     | -    | 显示申请日期     | 集配管理-div      |
| 申请人         | 文本     | -    | 显示申请人       | 集配管理-div      |
| 商品渠道       | 文本     | -    | 显示商品渠道     | 集配管理-div      |
```

**只识别了 5 个字段，漏掉了 7 个字段！准确率只有 42%！**

---

## 根本原因分析

### 原有的提取逻辑

[axureParseService.ts:288-386](../server/services/axureParseService.ts#L288-L386)（修改前）

```typescript
// 🔍 步骤2: 提取所有交互元素
const selectors = [
  'input',
  'button',
  'select',
  'textarea',
  'a[href]',
  '[data-label]',
  '[onclick]',
  '.btn',
  '.button',
  '[role="button"]',
  '[type="submit"]'
];

$(pageElem)
  .find(selectors.join(', '))
  .each((i, elem) => {
    // 只提取 input/button/select 等交互元素
    // ❌ 没有提取 div 文本元素！
  });

// 🔍 步骤3: 专门提取包含业务规则关键词的长文本div元素
$(pageElem).find('div').each((i, elem) => {
  const text = $elem.text().trim();

  // 只提取长文本且包含业务规则关键词的div
  if (text.length > 50 &&
      (text.includes('审核') || text.includes('校验') || ...)) {
    // 提取业务规则
    // ❌ 但是列头（如"当前审批节点"）不符合条件，被跳过了！
  }
});
```

### 问题

1. **步骤2 只提取交互元素**：只提取 `<input>`, `<button>`, `<select>` 等，不提取 `<div>` 文本
2. **步骤3 只提取业务规则**：只提取长文本（>50字）且包含特定关键词的 div
3. **列表字段被完全忽略**：像"当前审批节点"、"订单处理状态"这样的短文本 div 元素既不是交互元素，也不是业务规则，所以**被跳过了**！

### Axure 列表字段的实际结构

```html
<!-- "当前审批节点" 列头 -->
<div id="u2771" class="ax_default label">
  <div id="u2771_div" class=""></div>
  <div id="u2771_text" class="text ">
    <p><span>当前审批节点</span></p>
  </div>
</div>

<!-- "当前审批人" 列头 -->
<div id="u2772" class="ax_default label">
  <div id="u2772_div" class=""></div>
  <div id="u2772_text" class="text ">
    <p><span>当前审批人</span></p>
  </div>
</div>

<!-- "订单处理状态" 列头 -->
<div id="u2851" class="ax_default label">
  <div id="u2851_div" class=""></div>
  <div id="u2851_text" class="text ">
    <p><span>订单处理状态</span></p>
  </div>
</div>
```

这些都是 **`<div class="ax_default label">`** 元素，和按钮的结构完全一样！

---

## 修复方案

### ✅ 修复：添加步骤3提取所有 div.label 文本

**位置**: [axureParseService.ts:388-430](../server/services/axureParseService.ts#L388-L430)

**修改前**:
```typescript
// 🔍 步骤3: 专门提取包含业务规则关键词的长文本div元素
$(pageElem).find('div').each((i, elem) => {
  const text = $elem.text().trim();

  // 只提取长文本且包含业务规则关键词的div
  if (text.length > 50 && (text.includes('审核') || ...)) {
    // 提取业务规则
  }
});
```

**修改后**:
```typescript
// 🔍 步骤3: 提取 div 文本元素（列表字段、业务规则等）
$(pageElem).find('div.ax_default.label').each((i, elem) => {
  const $elem = $(elem);
  const text = $elem.text().trim();

  // 跳过隐藏元素
  const style = $elem.attr('style') || '';
  const isHidden = /display\s*:\s*none/i.test(style) || ...;
  if (isHidden) return;

  // 跳过空文本
  if (!text || text.length === 0) return;

  // 避免重复提取
  const elemId = $elem.attr('id');
  const alreadyExists = elements.some(e => e.id === elemId);
  if (alreadyExists) return; // 已经在步骤2中作为按钮提取过了

  // 🔥 关键改进：提取所有短文本的 div.label 作为列表字段或列头
  // 之前只识别按钮（≤10字），现在也识别列头（可能更长）
  if (text.length <= 50) {
    // 短文本：可能是列头、字段标签或按钮（按钮已在步骤2处理）
    elements.push({
      id: elemId || `div-${i}`,
      type: 'div',
      name: undefined,
      placeholder: undefined,
      text: text,
      value: undefined
    });
  }
});

// 🔍 步骤4: 专门提取包含业务规则关键词的长文本div元素
$(pageElem).find('div').each((i, elem) => {
  // ... 保持不变，继续提取业务规则
});
```

---

## 关键改进

### 1. 专门提取 `div.ax_default.label`

之前的逻辑在步骤2只提取交互元素，在步骤3只提取业务规则。现在添加新的步骤3：

- **选择器**：`div.ax_default.label`
- **条件**：文本长度 ≤ 50 个字符
- **目的**：提取所有列头、字段标签、按钮等短文本元素

### 2. 避免重复提取

```typescript
const alreadyExists = elements.some(e => e.id === elemId);
if (alreadyExists) return; // 已经在步骤2中作为按钮提取过了
```

因为按钮和列头使用相同的 HTML 结构（`div.ax_default.label`），所以需要避免重复。按钮已经在步骤2中被识别并设置 `type='button'`，这里会跳过它们。

### 3. 文本长度阈值

- **按钮识别**（步骤2）：≤ 10 字符 + 包含按钮关键词 → 识别为 button
- **字段提取**（步骤3）：≤ 50 字符 → 提取为 div（可能是列头、字段标签）
- **业务规则**（步骤4）：> 50 字符 + 包含关键词 → 提取为业务规则

### 4. 元素类型

提取后的元素：
- `type: 'button'` - 按钮（步骤2识别）
- `type: 'div'` - 列表字段、列头、标签等（步骤3提取）
- `type: 'div', name: '业务规则说明'` - 长文本业务规则（步骤4提取）

---

## 预期效果

### 修复前（5个字段）

```markdown
#### 1.1.2 列表展示字段
| 字段名         | 数据类型 | 格式 | 说明             | 来源              |
|----------------|---------|------|------------------|-------------------|
| 客户名称       | 文本     | -    | 显示客户名称     | 集配管理-div      |
| 商品总数量     | 数值     | -    | 显示商品总数量   | 集配管理-div      |
| 申请日期       | 日期     | -    | 显示申请日期     | 集配管理-div      |
| 申请人         | 文本     | -    | 显示申请人       | 集配管理-div      |
| 商品渠道       | 文本     | -    | 显示商品渠道     | 集配管理-div      |
```

### 修复后（12个字段）

```markdown
#### 1.1.2 列表展示字段
| 字段名                           | 数据类型 | 格式 | 说明                     | 来源              |
|----------------------------------|---------|------|--------------------------|-------------------|
| 客户名称                         | 文本     | -    | 显示客户名称             | 集配管理-div      |
| 商品总数量                       | 数值     | -    | 显示商品总数量           | 集配管理-div      |
| 申请日期                         | 日期     | -    | 显示申请日期             | 集配管理-div      |
| 申请人                           | 文本     | -    | 显示申请人               | 集配管理-div      |
| 商品渠道                         | 文本     | -    | 显示商品渠道             | 集配管理-div      |
| 结算总金额（集采含税采购成本）   | 金额     | 元   | 显示询价单商品成本之和   | 集配管理-div      |
| 结算总金额（集采含税V链供应价）  | 金额     | 元   | 显示V链供应价之和        | 集配管理-div      |
| 销售总金额                       | 金额     | 元   | 显示销售总金额           | 集配管理-div      |
| 当前审批节点                     | 文本     | -    | 显示当前审批节点         | 集配管理-div      |
| 当前审批人                       | 文本     | -    | 显示当前审批人           | 集配管理-div      |
| 当前状态                         | 文本     | -    | 显示订单当前状态         | 集配管理-div      |
| 订单处理状态                     | 文本     | -    | 显示订单处理状态         | 集配管理-div      |
```

**准确率从 42% 提升到 100%！**

---

## 测试步骤

### 1. 重启服务

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
npm run dev
```

### 2. 重新上传 Axure 文件

- ✅ 确保上传 HTML 文件：`集配管理（新增）-cby.html`
- ✅ 填写项目信息
- ✅ 点击"开始解析"

### 3. 生成需求文档

等待需求文档生成完成。

### 4. 验证结果

检查"列表展示字段"章节：

- ✅ **字段数量正确** - 如果原型有 12 个列，文档应该有 12 行
- ✅ **所有字段都列出** - 包括"当前审批节点"、"订单处理状态"等
- ✅ **长字段名完整** - "结算总金额（集采含税采购成本）（元）"完整显示

---

## 调试日志

如果字段仍然缺失，查看后端日志：

```
📄 开始解析Axure文件: .../集配管理（新增）-cby.html
🔍 步骤1: 尝试提取主内容区域...
  ✓ 找到主容器: #base
  📋 找到 X 个label-input关联
  ✅ 提取完成: XX 个元素 (包含业务规则说明)
    - input 类型: 6 个
    - button 类型: 10 个
    - div 类型: 50 个  ← 🔥 检查这一行，应该有很多 div
    - select 类型: 2 个
```

如果 `div 类型: 0 个` 或很少，说明提取逻辑有问题。

---

## 相关修复

### 相关问题 1: 下拉框选项未提取

用户还提到"下拉框选项未提取"。这是另一个问题，需要：

1. 提取 `<select>` 元素的 `<option>` 子元素
2. 或者通过 AI 预分析识别下拉框的可选值

这将在后续修复中处理。

### 相关问题 2: 按钮识别

已在之前的修复中解决：[axure-button-detection-fix.md](axure-button-detection-fix.md)

---

## 技术细节

### Axure 元素分类

Axure RP 导出的 HTML 中，`<div class="ax_default label">` 可能表示：

| 用途 | 文本示例 | 长度 | type 识别 |
|------|---------|------|----------|
| 按钮 | "查询"、"审核" | 2-10字 | button（步骤2） |
| 列头 | "当前审批节点" | 5-20字 | div（步骤3） |
| 长字段名 | "结算总金额（集采含税...）" | 15-50字 | div（步骤3） |
| 字段标签 | "客户名称" | 3-6字 | div（步骤3） |
| 业务规则 | "审核通过时需要..." | >50字 | div（步骤4） |

### 提取流程

```
1. 读取 HTML 文件
2. 查找主容器 (#base 或 body)
3. 步骤1: 建立 label-input 映射
4. 步骤2: 提取交互元素 (input/button/select)
   ├─ 识别 Axure 按钮 (div.label + 关键词)
   └─ 设置 type='button'
5. 步骤3: 提取 div.label 文本 (≤50字) ← 🔥 新增
   ├─ 跳过已识别的按钮
   └─ 设置 type='div'
6. 步骤4: 提取业务规则 (>50字 + 关键词)
   └─ 设置 type='div', name='业务规则说明'
7. 返回所有提取的元素
```

---

## 潜在问题

### 1. 可能提取过多元素

由于现在提取所有 ≤50字 的 `div.label`，可能会提取一些不需要的元素（如导航菜单、页面标题等）。

**解决方案**: AI 会在生成需求文档时过滤掉不相关的元素。

### 2. 字段顺序可能不准确

HTML 中元素的顺序可能和视觉顺序不一致。

**解决方案**: 目前按 HTML 顺序提取，后续可以考虑使用元素的坐标信息排序。

### 3. 重复的列头

表格的列头和数据行可能都被提取。

**解决方案**: AI 会自动去重和合并。

---

**修复时间**: 2025-11-05
**版本**: v1.1
