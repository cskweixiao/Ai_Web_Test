# 🎨 AI 测试用例生成器详解

从 Axure 原型到测试用例，10 分钟完成 2-3 天的工作。

---

## 📖 功能概述

AI 测试用例生成器是 Sakura AI 的核心功能，能够从 Axure 原型文件自动生成高质量的功能测试用例。

### 核心价值

| 指标 | 传统手工编写 | AI 生成器 | 提升幅度 |
|------|------------|-----------|---------|
| **编写时间** | 2-3 天 | **10-30 分钟** | **20-50x** ⚡ |
| **功能覆盖率** | 60-70% | **85-95%** | **+25-35%** |
| **UI/文案覆盖率** | 0-20% | **80-95%** | **+60-95%** |
| **边界值覆盖率** | 40-60% | **80-95%**（RAG加持） | **+40-55%** |
| **风险场景识别** | 50-70% | **85-95%**（RAG加持） | **+35-45%** |
| **规范性** | 70-80% | **95%+** | **+15-25%** |
| **人力成本节省** | 100% | **10-20%** | **节省 80-90%** |

---

## 🔄 完整工作流程

### 2 步审核 + 3 阶段生成

```
📤 步骤 1：上传 Axure 原型
   ↓ AI 深度解析
   输出：结构化需求文档（Markdown）
   ↓
✋ 步骤 2：人工审核需求文档（第 1 个审核点）
   ↓ 可编辑修正
   输出：审核后的需求文档
   ↓
🔄 阶段 1：AI 拆分测试模块
   ↓ 基于需求文档上下文
   输出：3-6 个测试模块
   ↓
✋ 第 2 个审核点：选择要生成测试目的的模块
   ↓
🎯 阶段 2：AI 生成测试目的
   ↓ 继承模块 + 需求文档上下文
   输出：每个模块 2-8 个测试目的
   ↓
✋ 第 3 个审核点：选择要生成测试点的测试目的
   ↓
✅ 阶段 3：AI 生成测试点 + RAG 知识库增强
   ↓ 继承测试目的 + 模块 + 需求文档 + RAG 检索知识
   输出：每个测试目的 3-10 个测试点
   ↓
✋ 第 4 个审核点：查看/编辑/选择要保存的测试用例
   ↓
💾 一键保存到用例库
```

---

## 📤 步骤 1：上传 Axure 原型

### 支持的文件格式

- `.html` - Axure 发布的 HTML 文件
- `.htm` - Axure 发布的 HTM 文件

### Axure 导出步骤

1. 在 Axure 中打开原型项目
2. 点击 **发布** → **生成 HTML 文件**
3. 选择发布目录
4. 完成后上传生成的 HTML 文件到 Sakura AI

### AI 自动解析内容

AI 会自动提取以下信息：

✅ **页面结构**
- 页面类型识别（列表页/表单页/详情页/混合页）
- 页面元素识别（输入框、按钮、表格、下拉框等）
- 页面布局和分区

✅ **交互逻辑**
- 按钮点击事件
- 表单提交流程
- 页面跳转关系
- 条件显示/隐藏

✅ **业务规则**
- 必填项标识
- 数据验证规则
- 提示信息和错误提示

✅ **文案内容**
- 标题、标签文案
- 按钮文案
- 提示文案
- 表格列名

### 输出：结构化需求文档

AI 生成的需求文档采用 Markdown 格式，包含以下章节：

```markdown
# 需求文档：XXX 页面

## 1. 页面概述
- 页面名称
- 页面类型
- 功能描述

## 2. 页面元素
- 输入控件列表
- 操作按钮列表
- 展示组件列表

## 3. 交互流程
- 用户操作流程
- 页面跳转逻辑

## 4. 业务规则
- 验证规则
- 数据约束
- 异常处理

## 5. 页面布局与文案校验 🆕
- 页面标题和子标题
- 表单字段标签
- 按钮文案
- 提示信息
```

---

## ✋ 步骤 2：人工审核需求文档

### 为什么需要人工审核？

- ✅ AI 可能误解原型意图
- ✅ 补充隐藏的业务规则
- ✅ 修正元素识别错误
- ✅ 确保生成方向正确

### 审核界面功能

**在线富文本编辑器**：
- 支持 Markdown 语法
- 实时预览
- 支持撤销/重做
- 支持全屏编辑

**审核重点**：
1. 页面功能理解是否准确？
2. 关键业务规则是否遗漏？
3. 元素识别是否完整？
4. 文案描述是否正确？

### 示例：修正需求文档

**AI 原始输出**：
```markdown
## 业务规则
- 用户名必填
- 密码必填
```

**人工修正后**：
```markdown
## 业务规则
- 用户名必填，格式为邮箱
- 密码必填，长度 6-20 位，必须包含数字和字母
- 登录失败 3 次后锁定账户 30 分钟 ⬅️ 补充的规则
```

---

## 🔄 阶段 1：AI 拆分测试模块

### 工作原理

基于审核后的需求文档，AI 自动识别测试模块：

**根据页面类型智能拆分**：

| 页面类型 | 典型测试模块 |
|---------|------------|
| **列表页** | 查询条件测试、列表展示测试、操作按钮测试、布局文案测试 |
| **表单页** | 表单字段验证、字段联动、提交保存测试、布局文案测试 |
| **详情页** | 详情展示测试、操作按钮测试、布局文案测试 |
| **混合页** | 综合各页面类型的模块 |

### 输出示例

**原型**：用户管理列表页

**AI 生成的测试模块**：
```
1. 查询条件测试
2. 用户列表展示测试
3. 新增/编辑/删除操作测试
4. 批量操作测试
5. 页面布局与文案校验 🆕
```

### 第 2 个审核点：选择模块

用户可以：
- ✅ 全选所有模块
- ✅ 选择部分模块
- ✅ 跳过不需要的模块

---

## 🎯 阶段 2：AI 生成测试目的

### 工作原理

**继承上下文**：
- ✅ 需求文档（步骤 2 审核后的）
- ✅ 选中的测试模块（阶段 1 选择的）

**根据模块类型生成测试目的**：

### 输出示例

**测试模块**：查询条件测试

**AI 生成的测试目的**：
```
1. 单条件查询验证
2. 多条件组合查询验证
3. 查询条件必填校验
4. 查询结果正确性验证
5. 查询条件清空功能验证
6. 特殊字符和边界值查询验证
```

### 第 3 个审核点：选择测试目的

用户可以：
- ✅ 全选所有测试目的
- ✅ 选择部分测试目的
- ✅ 跳过不需要的测试目的

---

## ✅ 阶段 3：AI 生成测试点 + RAG 知识库增强

### ⭐ 核心创新：RAG 知识库介入

**仅在此阶段使用 RAG**，因为：
- 前两个阶段主要是业务理解和结构拆分
- 阶段 3 才需要详细的测试步骤、边界值、风险场景

### 工作原理

```
用户选择测试目的："单条件查询验证"
   ↓
🔍 Step 1: 向量化查询
   "单条件查询验证" + 需求文档相关章节
   ↓ 阿里通义 Embedding API
   生成 1024 维向量
   ↓
📚 Step 2: Qdrant 语义检索（相似度 ≥ 0.5）
   从 test_knowledge_{systemName} 集合中检索
   ↓
   检索结果：
   ✅ 业务规则（2 条，相似度 85%, 72%）
      1. "查询条件必填项校验规则"
      2. "日期范围查询格式要求"
   ✅ 测试模式（1 条，相似度 69%）
      1. "组合查询边界值测试模板"
   ✅ 历史踩坑（1 条，相似度 61%）
      1. "特殊字符未转义导致查询失败"
   ✅ 风险场景（0 条）
   ↓
🎯 Step 3: 构建知识上下文（Markdown 格式）
   ↓
💬 Step 4: 注入 AI Prompt
   系统提示词 + 知识上下文 + 需求文档 + 测试目的
   ↓ OpenRouter API（GPT-4o / DeepSeek / Claude）
   ↓
📝 输出：专业测试用例
```

### 输出示例

**测试目的**：单条件查询验证

**AI 生成的测试点（含 RAG 增强）**：

```json
{
  "testPoints": [
    {
      "title": "必填项为空测试",
      "steps": [
        "1. 不输入任何查询条件",
        "2. 点击查询按钮"
      ],
      "expectedResult": "提示"请输入查询条件"",
      "riskLevel": "medium",
      "source": "业务规则知识库" ⬅️ RAG 来源
    },
    {
      "title": "日期格式错误测试",
      "steps": [
        "1. 输入错误日期格式"2025-13-01"",
        "2. 点击查询按钮"
      ],
      "expectedResult": "提示"日期格式错误，请输入YYYY-MM-DD格式"",
      "riskLevel": "medium",
      "source": "业务规则知识库" ⬅️ RAG 来源
    },
    {
      "title": "特殊字符输入测试",
      "steps": [
        "1. 在查询条件输入特殊字符：test' OR '1'='1",
        "2. 点击查询按钮"
      ],
      "expectedResult": "查询失败或无结果，系统不应报错或崩溃",
      "riskLevel": "high",
      "source": "历史踩坑知识库" ⬅️ RAG 来源
    },
    {
      "title": "边界值测试：最大长度",
      "steps": [
        "1. 输入 100 个字符的查询条件",
        "2. 点击查询按钮"
      ],
      "expectedResult": "系统正常处理或提示"查询条件过长"",
      "riskLevel": "low",
      "source": "测试模式知识库" ⬅️ RAG 来源
    }
  ]
}
```

### RAG 增强效果对比

| 测试场景 | 无 RAG 生成 | 有 RAG 生成 | RAG 知识来源 |
|---------|-----------|------------|-------------|
| 查询条件 | ✅ 正常查询测试 | ✅ 正常 + 边界值（空值、最大长度） | 业务规则 |
| 日期输入 | ✅ 正常日期测试 | ✅ 正常 + 错误格式（2025-13-01） | 业务规则 |
| 特殊字符 | ❌ 未考虑 | ✅ SQL 注入风险测试（`' OR '1'='1`） | 风险场景 |
| 并发查询 | ❌ 未考虑 | ✅ 100 并发查询性能测试 | 历史踩坑 |
| 覆盖率 | 70% | 90% | +20% |

### 第 4 个审核点：查看/编辑/保存

用户可以：
- ✅ 查看生成的测试点
- ✅ 编辑测试步骤和预期结果
- ✅ 选择要保存的测试点
- ✅ 一键保存到用例库

---

## 🎯 最佳实践

### Axure 原型准备建议

✅ **推荐做法**：
- 原型结构清晰，页面命名规范
- 交互逻辑完整，流程闭环
- 关键业务规则体现在原型中
- 使用 Axure 标准组件

❌ **避免问题**：
- 原型过于粗糙，缺少细节
- 页面命名随意（page1, page2...）
- 交互关系缺失或混乱
- 大量使用自定义图片

### 人工审核重点

**步骤 2 审核需求文档**：
- ✅ 补充隐藏的业务规则
- ✅ 修正元素识别错误
- ✅ 完善交互流程描述

**阶段 1 选择测试模块**：
- ✅ 优先选择核心功能模块
- ✅ 可分批生成，避免一次性过多

**阶段 2 选择测试目的**：
- ✅ 优先生成高风险测试目的
- ✅ 平衡正常流程和异常流程

**阶段 3 审核测试点**：
- ✅ 检查步骤是否完整
- ✅ 检查预期结果是否明确
- ✅ 删除重复或不适用的测试点

---

## 🚀 快速开始

### 访问 AI 生成器

```bash
# 方式 1：导航菜单
功能测试用例 → AI 生成器

# 方式 2：直接访问
http://localhost:5173/functional-test-cases/generator
```

### 完整流程演示

```bash
1. 点击"上传 Axure 文件"
2. 选择 .html 文件
3. 等待 AI 生成需求文档（约 30 秒）
4. 审核并修正需求文档
5. 点击"生成测试模块"（约 10 秒）
6. 选择要生成的模块
7. 点击"生成测试目的"（约 10 秒）
8. 选择要生成的测试目的
9. 点击"生成测试点"（约 30-60 秒，含 RAG 检索）
10. 审核并选择要保存的测试点
11. 点击"保存到用例库"
```

---

## 📊 技术实现

### 核心服务

| 文件 | 功能 |
|------|------|
| `server/services/functionalTestCaseAIService.ts` | AI 生成主服务 |
| `server/services/axureService.ts` | Axure HTML 解析 |
| `server/services/testCaseKnowledgeBase.ts` | RAG 知识库检索 |
| `server/services/llmConfigManager.ts` | AI 模型管理 |

### AI 提示词策略

**步骤 1：需求文档生成**：
- 身份：业务分析专家
- 任务：解析 Axure HTML，生成结构化需求文档
- 约束：忠实原型，不编造内容

**阶段 1：测试模块拆分**：
- 身份：测试架构师
- 任务：根据需求文档拆分测试模块
- 约束：3-6 个模块，按页面类型智能识别

**阶段 2：测试目的生成**：
- 身份：测试设计专家
- 任务：根据模块生成测试目的
- 约束：2-8 个测试目的，覆盖正常和异常流程

**阶段 3：测试点生成 + RAG**：
- 身份：顶级测试专家
- 任务：生成详细测试点
- 约束：3-10 个测试点，注入 RAG 知识
- 特殊：包含边界值、风险场景、历史踩坑

---

## 🔗 相关文档

- [RAG 知识库配置](RAG_SETUP.md) - 提升测试用例质量
- [安装指南](INSTALLATION.md) - 环境配置
- [配置说明](CONFIGURATION.md) - AI 模型配置

---

**返回**: [README](../README.md)
