=== Git 提交说明 ===

---

日期: 2025-12-23
功能: 多文件上传组件新增文件数量和大小超限弹窗提示，修复文件大小限制配置错误，添加详细调试日志，创建统一的上传配置管理

修改文件:
- src/components/ai-generator/MultiFileUpload.tsx
- src/pages/FunctionalTestCaseGenerator.tsx
- src/config/upload.ts (新建)
- server/config/upload.ts (新建)
- server/middleware/upload.ts

修改内容:
0. 修复关键 Bug：文件大小限制配置错误
   - 将 maxSize 默认值从错误的 1MB (1 * 1024 * 1024) 修正为 10MB (10 * 1024 * 1024)
   - 确保代码实现与注释说明一致
   - 这是导致 10MB 文件无法正常显示弹窗的根本原因

0.1. 新增对 DOC 文件（旧版 Word 文档）的支持
   - 在 UploadedFile 类型定义中添加 'doc' 类型
   - 在文件类型验证逻辑中添加 .doc 文件识别
   - 在 useDropzone 配置中添加 'application/msword' MIME 类型支持
   - 更新所有 UI 提示文本，将 DOC 添加到支持的文件类型列表中
   - 更新文件图标显示逻辑，DOC 和 DOCX 使用相同的蓝色 Word 图标
   - 更新预览按钮条件，DOC 文件也可以预览
   - 更新 mainCount 计算逻辑，将 DOC 文件算入主文件数量
   - 修复用户上传 .doc 文件时无法通过文件类型过滤导致的无弹窗问题

0.2. 修复父组件传入的文件大小限制不一致问题
   - 发现 FunctionalTestCaseGenerator 传入 maxSize={50 * 1024 * 1024} (50MB)
   - 与 MultiFileUpload 组件默认值 10MB 不一致，导致弹窗逻辑失效
   - 将父组件的 maxSize 修正为 10MB，确保与组件设计意图一致
   - 添加注释说明限制原因：确保 AI 模型最佳处理效果
   - 这是导致用户上传 10MB 文件无弹窗提示的真正根源

0.3. 创建统一的文件上传配置管理系统
   - 新建 src/config/upload.ts - 前端配置文件
   - 新建 server/config/upload.ts - 后端配置文件
   - 定义全局常量 MAX_FILE_SIZE = 10MB、MAX_FILES = 20
   - 定义支持的文件类型常量，避免硬编码
   - 提供辅助函数：getAllSupportedExtensions、isSupportedFileType、formatFileSize
   - 更新 server/middleware/upload.ts 使用配置常量
   - 更新 src/components/ai-generator/MultiFileUpload.tsx 使用配置常量
   - 更新 src/pages/FunctionalTestCaseGenerator.tsx 使用配置常量
   - 确保前后端文件大小和数量限制完全一致
   - 解决了之前前端传 50MB、后端也是 50MB 的配置不一致问题
   - 统一为 10MB，确保 AI 模型最佳处理效果

0.4. 新增详细的控制台调试日志
   - 在 onDrop 函数中添加详细日志，记录接收到的文件信息
   - 记录每个文件的名称、大小（字节和MB）、类型和是否超限
   - 在文件大小检查时记录 maxSize 限制值（帮助发现父组件传入的实际值）
   - 在触发超大文件弹窗时记录文件列表
   - 在 validateFile 函数中记录文件验证过程和结果
   - 添加 useEffect 监控 oversizedFiles 和 exceededFiles 状态变化
   - 在组件渲染时记录弹窗显示状态
   - 在弹窗关闭时记录操作
   - 通过调试日志成功定位父组件传入 50MB 限制的问题
   
1. 新增文件数量超限检测和提示功能
   - 添加 exceededFiles 状态管理超出数量限制的文件列表
   - 在 onDrop 函数中增加文件数量检查逻辑
   - 当上传文件总数超过 maxFiles 限制时，自动弹出提示对话框
   
2. 优化文件数量限制处理逻辑
   - 从 useDropzone 配置中移除 maxFiles 参数
   - 改为在 onDrop 中自定义处理，以便提供友好的用户提示
   - 精确计算允许添加的文件数量和被拒绝的文件数量
   - 只添加允许范围内的文件，超出部分显示在弹窗中

3. 优化文件大小限制处理逻辑
   - 从 useDropzone 配置中移除 maxSize 参数
   - 改为在 onDrop 中自定义处理，确保自定义弹窗能正常显示
   - 保持已有的 oversizedFiles 状态和弹窗组件
   - 避免 react-dropzone 自动拒绝文件导致用户看不到友好提示

4. 文件数量超限弹窗特性
   - 使用橙色警告色调区分于文件大小超限（红色）
   - 清晰展示当前文件数、最大限制数和超出文件数
   - 列出所有被拒绝的文件名称和大小
   - 提供友好的解决建议：删除部分文件后再添加、分批上传等

5. 文件大小超限弹窗特性（已存在，优化配置）
   - 使用红色警告色调突出文件大小问题
   - 清晰展示超限文件列表和实际大小（MB）
   - 提供友好的解决建议：拆分大文件、压缩优化等
   - 阻止超大文件上传，避免 AI 处理失败
   
6. 代码逻辑优化
   - 将文件数量和大小检查从简单处理改为完整的检测和提示流程
   - 区分"允许添加的文件"和"被拒绝的文件"
   - 确保用户明确知道哪些文件因为限制无法上传
   - 添加详细的注释说明逻辑处理流程

技术实现:
- 使用 antd Modal 组件实现响应式弹窗
- 使用橙色主题（orange-500）表示数量限制，红色主题（red-500）表示大小限制
- 在 onDrop 回调中增加文件数量和大小的预检查和分割逻辑
- 使用 lucide-react 的 AlertCircle 图标增强视觉提示
- 移除 useDropzone 的 maxFiles 和 maxSize 配置，完全使用自定义逻辑

用户体验提升:
- 用户上传超过限制的文件时立即获得清晰反馈（数量或大小）
- 明确知道哪些文件因为什么原因被拒绝
- 了解当前状态和系统限制
- 获得实用的解决建议，指导用户正确处理文件上传
- 避免文件被静默截断或拒绝，提升透明度和可控性
- 两种限制使用不同颜色区分，更符合用户认知

---

日期: 2025-12-23
功能: 多文件上传组件新增文件大小限制和弹窗提示

修改文件:
- src/components/ai-generator/MultiFileUpload.tsx

修改内容:
1. 调整文件大小限制
   - 将默认最大文件大小从 50MB 调整为 10MB
   - 根据 AI 模型对文本的最佳处理能力设置合理上限
   - 确保上传文件能够被 AI 模型有效处理

2. 新增文件大小超限弹窗提示
   - 引入 antd 的 Modal 组件实现弹窗
   - 添加 oversizedFiles 状态管理超大文件列表
   - 在用户上传超大文件时自动弹出提示对话框

3. 弹窗功能特性
   - 清晰展示超限文件列表，包含文件名和实际大小
   - 提供友好的提示信息和解决建议
   - 建议用户拆分大文件或压缩优化内容
   - 阻止超大文件上传，避免处理失败

4. 代码优化
   - 使用 useCallback 包装 validateFile 函数
   - 修复 React Hook 依赖项警告
   - 添加 eslint-disable 注释处理预留接口参数
   - 移除未使用的 Radio 组件导入

5. UI/UX 设计
   - 使用红色警告色调突出超限提示
   - 显示每个超限文件的具体大小（MB）
   - 提供蓝色提示框展示优化建议
   - 居中显示模态框，提升视觉体验

技术实现:
- 在 onDrop 回调中添加文件大小预检查
- 使用 antd Modal 组件实现响应式弹窗
- 使用 lucide-react 的 AlertCircle 图标增强视觉提示
- 优化 useCallback 依赖项，避免不必要的重新渲染

用户体验提升:
- 用户上传超大文件时立即获得清晰反馈
- 提供具体的文件大小信息，帮助用户了解超限程度
- 给出实用的优化建议，指导用户正确处理大文件
- 确保上传的文件能够被 AI 模型有效处理，提升成功率

---

日期: 2025-12-23
功能: 缓存统计页面趋势图增强

修改文件:
- src/pages/CacheStats.tsx

修改内容:
1. 新增趋势图样式切换功能（折线图、柱状图、面积图）
2. 在趋势图右上角添加样式切换器，参考 TestRuns.tsx 的视图切换实现
3. 优化图表展示：
   - 添加网格线（CartesianGrid）增强可读性
   - 添加横轴时间标签和纵轴数量标签
   - 添加图例（Legend）显示数据说明
4. 三种图表样式：
   - 折线图：经典趋势展示，带数据点高亮
   - 柱状图：对比数据更直观，带圆角美化
   - 面积图：渐变填充效果，更具视觉冲击力
5. 清理未使用的导入（DollarOutlined, FallOutlined, MemoryStickIcon）

技术实现:
- 使用 recharts 库的 LineChart、BarChart、AreaChart 组件
- 使用 lucide-react 图标库的 LineChartIcon、BarChart3、AreaChartIcon
- 使用 clsx 实现动态样式切换
- 封装 renderChartStyleSwitcher 和 renderTrendChart 函数提高代码复用性

用户体验提升:
- 用户可根据需要切换图表样式，更灵活地查看数据
- 统一的切换器设计风格与系统其他页面保持一致
- 图表添加标签和图例，数据含义更清晰

---

日期: 2025-12-23
功能: 证据查看器增加视频和日志在线查看功能

修改文件:
- src/components/EvidenceViewerNew.tsx

修改内容:
1. 为视频文件添加在线查看功能
   - 新增 handleViewVideo 函数处理视频预览
   - 添加视频预览模态框，使用 HTML5 video 标签播放
   - 支持视频播放控制（播放、暂停、音量、全屏等）
   
2. 为日志文件添加在线查看功能
   - 新增 handleViewLog 函数处理日志预览
   - 在新窗口中展示日志内容，使用深色主题
   - 格式化日志展示，使用等宽字体提高可读性
   - 添加固定顶部标题栏显示文件名

3. 更新"其他文件"区域UI
   - 为 video 类型文件添加"在线查看"按钮
   - 为 log 类型文件添加"在线查看"按钮
   - 保持与现有 trace 文件一致的UI风格

4. 新增状态管理
   - videoPreviewUrl：视频预览URL
   - videoFilename：视频文件名
   - closeVideoPreview：关闭视频预览函数

5. 代码优化
   - 清理未使用的导入（RefreshCw）
   - 删除未使用的变量（isLoading）
   - 修复所有 linter 错误

技术实现:
- 使用 framer-motion 的 AnimatePresence 实现视频预览模态框动画
- 使用 fetch API 获取签名URL和日志内容
- 使用 HTML5 video 标签原生播放器
- 新窗口展示日志时使用内联样式实现深色代码编辑器主题

用户体验提升:
- 用户无需下载即可直接在线查看视频和日志文件
- 视频支持播放控制，观看更便捷
- 日志以代码编辑器风格展示，阅读体验更佳
- 统一的操作界面，降低学习成本

---

